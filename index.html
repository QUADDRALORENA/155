<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pipeline — Parcerias</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary:#3b82f6;
      --secondary:#6366f1;
      --success:#10b981;
      --warning:#f59e0b;
      --info:#06b6d4;
      --dark:#1f2937;
      --light:#f9fafb;
      --border:#e5e7eb;
      --card-shadow:0 4px 10px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;margin:0}
    body{background:#f3f4f6;color:var(--dark);padding:18px}
    .container{max-width:1300px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
    .logo{display:flex;align-items:center;gap:12px;font-weight:700;color:var(--primary)}
    .logo img{height:44px;border-radius:8px;object-fit:cover}
    .title{font-size:1.25rem;display:flex;align-items:center;gap:10px}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 14px;border-radius:8px;background:white;border:1px solid var(--border);cursor:pointer;font-weight:600}
    .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .subheader{margin:12px 0 18px;color:#374151}
    /* Pipeline */
    .pipeline-container{display:flex;gap:18px;overflow-x:auto;padding-bottom:8px}
    .pipeline-col{flex:0 0 320px;background:white;border-radius:12px;box-shadow:var(--card-shadow);display:flex;flex-direction:column;max-height:78vh}
    .col-header{padding:14px;background:var(--light);border-bottom:1px solid var(--border);border-radius:12px 12px 0 0}
    .col-header h3{margin:0;font-size:1rem}
    .col-header .meta{display:flex;justify-content:space-between;margin-top:8px;align-items:center}
    .count-value{background:var(--primary);color:#fff;padding:4px 8px;border-radius:999px;font-weight:700;font-size:0.85rem}
    .vgv-total{margin-top:8px;font-weight:700;color:var(--success)}
    .col-content{padding:10px;overflow:auto;background:#fbfdff}
    .group{margin-bottom:12px;padding-bottom:10px;border-bottom:1px dashed var(--border)}
    .group h4{margin:0 0 8px;font-size:0.95rem;display:flex;justify-content:space-between;align-items:center}
    .group .group-meta{font-size:0.85rem;color:#374151;font-weight:700}
    .item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;margin-bottom:6px;background:#fff;border:1px solid var(--border);font-size:0.88rem}
    .item .left{max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:600;color:var(--dark)}
    .item .right{display:flex;gap:8px;align-items:center;font-size:0.85rem;color:#374151}
    .badge-origin{background:#f3f4f6;padding:4px 8px;border-radius:6px;font-weight:700;font-size:0.78rem}
    .vgv-chip{font-weight:800}
    .item.vendido{border-left:5px solid var(--success)}
    .item.processo{border-left:5px solid var(--primary)}
    .item.proposta{border-left:5px solid var(--warning)}
    .item.tratativa{border-left:5px solid var(--info)}
    .tooltip{position:absolute;background:#0f172a;color:white;padding:10px;border-radius:8px;font-size:0.85rem;max-width:280px;box-shadow:0 6px 18px rgba(2,6,23,0.4);z-index:9999;display:none}
    @media (max-width:900px){.pipeline-col{flex:0 0 280px}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">
      <img src="https://th.bing.com/th/id/OIP.DiD5B1544bP-WOFlfbxsawAAAA?w=176&h=180&c=7&r=0&o=7&cb=12&dpr=1.3&pid=1.7&rm=3" alt="logo">
      <div>
        <div class="title"><i class="fas fa-handshake" style="color:#f59e0b"></i> Pipeline — Parcerias</div>
        <div style="font-size:0.85rem;color:#6b7280">Visão segmentada: por Produto ou por Gerente</div>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" id="tab-produto">Por Produto</div>
      <div class="tab" id="tab-gerente">Por Gerente</div>
    </div>
  </header>

  <div class="subheader" id="statusMsg">Carregando dados...</div>
  <div class="pipeline-container" id="pipelineRoot"></div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9R2T1zawyCaPSen3aPG4V_gQfeWejonsuchFczZjHCO1ok5-s5K75FU-J3o1JPZezRrtbx646_I3b/pub?gid=0&single=true&output=csv';
let currentGroupBy = 'PROJETO';
let rawData = [];

function mapStatus(v){
  if(!v) return 'TRATATIVA';
  v=v.toUpperCase();
  if(v.includes('VEND')) return 'VENDIDO';
  if(v.includes('PROCESS')) return 'PROCESSO';
  if(v.includes('PROP')) return 'PROPOSTA';
  return 'TRATATIVA';
}
function parseVgv(v){return parseFloat(String(v).replace(/[^\d,.\-]/g,'').replace(',','.'))||0}
function formatBr(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}

function csvToJson(txt){
  const lines = txt.trim().split(/\r?\n/);
  const sep = lines[0].includes(';')?';':',';
  const headers = lines[0].split(sep).map(h=>h.trim());
  return lines.slice(1).map(l=>{
    const cols=l.split(sep);
    const o={};
    headers.forEach((h,i)=>o[h.trim().toUpperCase()]=cols[i]?cols[i].trim():'');
    return o;
  });
}

async function loadData(){
  document.getElementById('statusMsg').textContent='Carregando CSV...';
  const res=await fetch(CSV_URL);
  const txt=await res.text();
  rawData=csvToJson(txt);
  render();
}

function render(){
  const root=document.getElementById('pipelineRoot');
  root.innerHTML='';
  const buckets={VENDIDO:[],PROCESSO:[],PROPOSTA:[],TRATATIVA:[]};
  rawData.forEach(r=>{
    const st=mapStatus(r.STATUS);
    buckets[st].push({
      status:st,
      gerente:r.GERENTE||'—',
      projeto:r.PROJETO||'—',
      unidade:r.UNIDADE||'—',
      origem:r.ORIGEM||'—',
      tooltip:r.TOOLTIP||'',
      vgv:parseVgv(r.VGV)
    });
  });
  const order=[{k:'VENDIDO',l:'Vendido'},{k:'PROCESSO',l:'Processo'},{k:'PROPOSTA',l:'Proposta'},{k:'TRATATIVA',l:'Tratativa'}];
  order.forEach(c=>{
    const items=buckets[c.k];
    const col=document.createElement('div');
    col.className='pipeline-col';
    const total=items.length;
    const sum=items.reduce((s,i)=>s+i.vgv,0);
    col.innerHTML=`
      <div class="col-header">
        <h3>${c.l}</h3>
        <div class="meta"><span>Total:</span><span class="count-value">${total}</span></div>
        <div class="vgv-total">${formatBr(sum)}</div>
      </div>
      <div class="col-content"></div>`;
    const body=col.querySelector('.col-content');
    const groups={};
    items.forEach(i=>{
      const key=currentGroupBy==='GERENTE'?i.gerente:i.projeto;
      if(!groups[key])groups[key]={items:[],vgv:0};
      groups[key].items.push(i);
      groups[key].vgv+=i.vgv;
    });
    Object.entries(groups).forEach(([g,grp])=>{
      const gEl=document.createElement('div');
      gEl.className='group';
      gEl.innerHTML=`<h4>${g}<span class="group-meta">${grp.items.length} • ${formatBr(grp.vgv)}</span></h4>`;
      grp.items.forEach(it=>{
        const item=document.createElement('div');
        item.className='item '+it.status.toLowerCase();
        item.innerHTML=`
          <div class="left">${it.unidade}</div>
          <div class="right">
            <div class="badge-origin">${it.origem}</div>
            <div class="vgv-chip">${formatBr(it.vgv)}</div>
            <i class="fas fa-info-circle" style="cursor:pointer" data-tip="${it.tooltip||''}"></i>
          </div>`;
        item.querySelector('i').addEventListener('mouseenter',e=>showTip(e,it.tooltip||buildTip(it)));
        item.querySelector('i').addEventListener('mouseleave',hideTip);
        gEl.appendChild(item);
      });
      body.appendChild(gEl);
    });
    root.appendChild(col);
  });
  document.getElementById('statusMsg').textContent=`Registros carregados: ${rawData.length}`;
}

function buildTip(it){return `Gerente: ${it.gerente}<br>Projeto: ${it.projeto}<br>Origem: ${it.origem}<br>VGV: ${formatBr(it.vgv)}`}
const tip=document.getElementById('tooltip');
function showTip(e,txt){tip.innerHTML=txt;tip.style.display='block';const r=e.target.getBoundingClientRect();tip.style.top=(window.scrollY+r.top- tip.offsetHeight-10)+'px';tip.style.left=(r.left)+'px'}
function hideTip(){tip.style.display='none'}

document.getElementById('tab-produto').onclick=()=>{switchTab('PROJETO')}
document.getElementById('tab-gerente').onclick=()=>{switchTab('GERENTE')}
function switchTab(by){
  currentGroupBy=by;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(by==='PROJETO'?'tab-produto':'tab-gerente').classList.add('active');
  render();
}

loadData();
</script>
</body>
</html>
