<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pipeline — PARCERIAS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary:#3b82f6;
      --secondary:#6366f1;
      --success:#10b981;
      --warning:#f59e0b;
      --info:#06b6d4;
      --dark:#1f2937;
      --light:#f9fafb;
      --border:#e5e7eb;
      --card-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0}
    body{background:#f3f4f6;color:var(--dark);padding:18px}
    .container{max-width:1300px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
    .logo{display:flex;align-items:center;gap:12px;font-weight:700;color:var(--primary)}
    .logo img{height:42px;border-radius:6px;object-fit:cover}
    .title{font-size:1.25rem;display:flex;align-items:center;gap:10px}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 14px;border-radius:8px;background:white;border:1px solid var(--border);cursor:pointer;font-weight:600}
    .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .subheader{margin:12px 0 18px;color:#374151}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:transparent;border:1px solid var(--border)}
    /* Pipeline layout */
    .pipeline-wrap{background:transparent}
    .pipeline-container{
      display:flex;
      gap:18px;
      overflow-x:auto;
      padding-bottom:8px;
    }
    .pipeline-col{
      flex:0 0 320px;
      background:white;
      border-radius:12px;
      box-shadow:var(--card-shadow);
      display:flex;
      flex-direction:column;
      max-height:78vh;
    }
    .col-header{
      padding:14px;
      background:var(--light);
      border-top-left-radius:12px;border-top-right-radius:12px;
      border-bottom:1px solid var(--border);
      flex-shrink:0;
    }
    .col-header h3{margin:0;font-size:1rem}
    .col-header .meta{display:flex;justify-content:space-between;margin-top:8px;align-items:center}
    .count-value{background:var(--primary);color:#fff;padding:4px 8px;border-radius:999px;font-weight:700;font-size:0.85rem}
    .vgv-total{margin-top:8px;font-weight:700;color:var(--success)}
    .col-content{padding:10px;overflow:auto;background:#fbfdff}
    /* grouping inside column */
    .group{
      margin-bottom:12px;padding-bottom:10px;border-bottom:1px dashed var(--border);
    }
    .group h4{margin:0 0 8px;font-size:0.95rem;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .group .group-meta{font-size:0.85rem;color:#374151;font-weight:700}
    .item{
      display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;margin-bottom:6px;background:#fff;border:1px solid var(--border);cursor:default;
      font-size:0.88rem;
    }
    .item .left{max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:600;color:var(--dark)}
    .item .right{display:flex;gap:8px;align-items:center;font-size:0.85rem;color:#374151}
    .badge-origin{background:#f3f4f6;padding:4px 8px;border-radius:6px;font-weight:700;font-size:0.78rem}
    .vgv-chip{font-weight:800}
    /* status color left border */
    .item.vendido{border-left:5px solid var(--success)}
    .item.processo{border-left:5px solid var(--primary)}
    .item.proposta{border-left:5px solid var(--warning)}
    .item.tratativa{border-left:5px solid var(--info)}
    /* tooltip */
    .tooltip {
      position: absolute;
      background:#0f172a;color:white;padding:10px;border-radius:8px;font-size:0.85rem;max-width:280px;box-shadow:0 6px 18px rgba(2,6,23,0.4);z-index:9999;display:none;
    }
    /* responsive */
    @media (max-width:900px){
      .pipeline-container{gap:12px}
      .pipeline-col{flex:0 0 280px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="https://tse1.mm.bing.net/th/id/OIP.czu4dFm01qMuerCk3BfRxwHaCN?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3" alt="logo">
        <div>
          <div class="title"><i class="fas fa-handshake" style="color:#f59e0b"></i> Pipeline — PARCERIAS</div>
          <div style="font-size:0.85rem;color:#6b7280">Visualização segmentada: Pipeline por Produto / Gerente</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div class="tabs" role="tablist">
          <div class="tab active" id="tab-produto" data-target="produto">Por Produto</div>
          <div class="tab" id="tab-gerente" data-target="gerente">Por Gerente</div>
        </div>
        <div style="font-size:0.85rem;color:#6b7280">Fonte: planilha pipeline — PARCERIAS</div>
      </div>
    </header>

    <div class="subheader">
      <span id="statusMsg">Carregando dados...</span>
    </div>

    <div class="pipeline-wrap">
      <div class="pipeline-container" id="pipelineRoot">
        <!-- Columns will be injected here -->
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button class="btn primary" id="refreshBtn"><i class="fas fa-sync"></i> Recarregar</button>
      <button class="btn ghost" id="downloadBtn"><i class="fas fa-download"></i> Exportar CSV filtrado</button>
      <div style="margin-left:auto;color:#6b7280;font-size:0.9rem">Filtro atual: <strong>PARCERIAS</strong></div>
    </div>

  </div>

  <div class="tooltip" id="globalTooltip"></div>

<script>
/*
  pipeline-parcerias.html
  - Carrega CSV do pipeline
  - Filtra EMPRESA == 'PARCERIAS'
  - Mostra 4 colunas: Vendido | Processo | Proposta | Tratativa
  - Duas abas: agrupar por PROJETO (Produto) e GERENTE
  - Colunas e itens com contadores e soma VGV
*/

/* ---------- CONFIG ---------- */
const PIPELINE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9R2T1zawyCaPSen3aPG4V_gQfeWejonsuchFczZjHCO1ok5-s5K75FU-J3o1JPZezRrtbx646_I3b/pub?gid=0&single=true&output=csv';
const COL_EMPRESA = 'EMPRESA';
const FILTER_EMPRESA = 'PARCERIAS';

const EXPECTED_COLUMNS = {
  STATUS: 'STATUS',
  GERENTE: 'GERENTE',
  PROJETO: 'PROJETO',
  UNIDADE: 'UNIDADE',
  ORIGEM: 'ORIGEM',
  TOOLTIP: 'TOOLTIP',
  VGV: 'VGV',
  EMPRESA: 'EMPRESA'
};

/* status buckets mapping (case-insensitive match) */
function mapStatus(raw) {
  if (!raw) return 'TRATATIVA';
  const s = raw.toString().toUpperCase();
  if (s.includes('VEND')) return 'VENDIDO';
  if (s.includes('PROCESS')) return 'PROCESSO';
  if (s.includes('PROPOST')) return 'PROPOSTA';
  if (s.includes('TRAT')) return 'TRATATIVA';
  // fallbacks
  if (s.includes('FECH') || s.includes('CONCL')) return 'VENDIDO';
  return 'TRATATIVA';
}

/* ---------- CSV parsing (tolerante) ---------- */
function csvToJson(csv) {
  const lines = csv.split(/\r?\n/).filter(l => l.trim() !== '');
  if (!lines.length) return { data: [], headers: [] };
  // determine delimiter by first line
  const first = lines[0];
  const delimiter = first.includes(';') ? ';' : (first.includes('\t') ? '\t' : ',');
  const rawHeaders = first.split(delimiter).map(h => h.replace(/^"|"$/g,'').trim());
  const headersUpper = rawHeaders.map(h => h.toUpperCase());
  const data = [];
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split(delimiter);
    if (cols.every(c => c.trim() === '')) continue;
    const obj = {};
    for (let j=0;j<rawHeaders.length;j++){
      const key = rawHeaders[j] || `col_${j}`;
      const val = (cols[j] || '').trim().replace(/^"|"$/g,'');
      obj[key] = val;
      obj[key.toUpperCase()] = val; // also set uppercase key for ease
    }
    data.push(obj);
  }
  return { data, rawHeaders, headersUpper };
}

/* ---------- Helpers ---------- */
function parseNumber(v){
  if (v==null) return 0;
  // remove anything non-digit, non-comma, non-dot, including R$, spaces
  const cleaned = String(v).replace(/[^\d,.\-]/g,'').replace(',', '.');
  const n = parseFloat(cleaned);
  return isNaN(n) ? 0 : n;
}

function formatCurrencyBRL(n){
  try {
    return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:0,maximumFractionDigits:0});
  } catch(e){
    return 'R$ ' + Math.round(n);
  }
}

/* ---------- Rendering pipeline ---------- */

const pipelineRoot = document.getElementById('pipelineRoot');
const statusMsg = document.getElementById('statusMsg');
const tooltip = document.getElementById('globalTooltip');

let currentGroupBy = 'PROJETO'; // or 'GERENTE'
let lastRawData = [];

async function loadAndRender(){
  statusMsg.textContent = 'Carregando CSV...';
  pipelineRoot.innerHTML = '';
  try {
    const res = await fetch(PIPELINE_CSV_URL);
    if (!res.ok) throw new Error('Erro ao carregar CSV: ' + res.status);
    const txt = await res.text();
    const { data, rawHeaders } = csvToJson(txt);
    lastRawData = data;
    // normalize keys: prefer uppercase keys in object; find which column corresponds to our expected names
    // Try to find header names case-insensitively
    function getField(obj, possibleNames){
      for (const k of possibleNames){
        if (obj[k] !== undefined) return obj[k];
      }
      return '';
    }

    // Filter by EMPRESA contains PARCERIAS (case-insensitive)
    const filtered = data.filter(row => {
      const emp = getField(row, [EXPECTED_COLUMNS.EMPRESA, EXPECTED_COLUMNS.EMPRESA.toUpperCase(), 'EMPRESA', 'DIRETORIA', 'EMPRESA/SETOR']);
      return String(emp || '').toUpperCase().includes(FILTER_EMPRESA.toUpperCase());
    });

    if (!filtered.length) {
      statusMsg.innerHTML = '<span style="color:#92400e">Nenhum registro encontrado para PARCERIAS.</span>';
    } else {
      statusMsg.textContent = `Registros carregados: ${filtered.length} (filtrados por PARCERIAS)`;
    }

    renderPipeline(filtered);
  } catch(err){
    console.error(err);
    statusMsg.innerHTML = '<span style="color:#b91c1c">Erro ao carregar dados — verifique a URL do CSV.</span>';
    pipelineRoot.innerHTML = '';
  }
}

/* renderPipeline: recebe array de linhas (objetos) e monta a UI */
function renderPipeline(rows){
  // bucket rows by status
  const buckets = {
    VENDIDO: [],
    PROCESSO: [],
    PROPOSTA: [],
    TRATATIVA: []
  };

  rows.forEach(r => {
    // try to read fields tolerant to case
    const STATUS = (r['STATUS'] || r['Status'] || r['status'] || r['STAT'] || '').toString();
    const GERENTE = (r['GERENTE'] || r['Gerente'] || r['gerente'] || r['MANAGER'] || '').toString();
    const PROJETO = (r['PROJETO'] || r['Projeto'] || r['projeto'] || r['PRODUTO'] || '').toString();
    const UNIDADE = (r['UNIDADE'] || r['Unidade'] || r['unidade'] || r['UNID'] || '').toString();
    const ORIGEM = (r['ORIGEM'] || r['Origem'] || r['origem'] || r['MÍDIA'] || r['MIDIA'] || '').toString();
    const TOOLTIP = (r['TOOLTIP'] || r['Tooltip'] || r['tooltip'] || '').toString();
    const VGV_RAW = (r['VGV'] || r['Vgv'] || r['vgv'] || r['VALOR'] || '').toString();

    const statusKey = mapStatus(STATUS);
    const vgvNumber = parseNumber(VGV_RAW);

    const item = {
      raw: r,
      status: statusKey,
      gerente: GERENTE || '—',
      projeto: PROJETO || '—',
      unidade: UNIDADE || '—',
      origem: ORIGEM || '—',
      tooltip: TOOLTIP || '',
      vgv: vgvNumber
    };

    if (!buckets[statusKey]) buckets[statusKey] = [];
    buckets[statusKey].push(item);
  });

  // build columns in order: Vendido, Processo, Proposta, Tratativa
  pipelineRoot.innerHTML = '';
  const order = [
    { key: 'VENDIDO', label: 'Unidades Vendidas' },
    { key: 'PROCESSO', label: 'Processo' },
    { key: 'PROPOSTA', label: 'Propostas' },
    { key: 'TRATATIVA', label: 'Tratativas' }
  ];

  order.forEach(col => {
    const colEl = document.createElement('div');
    colEl.className = 'pipeline-col';
    const items = buckets[col.key] || [];

    // compute sums
    const totalCount = items.length;
    const totalVgv = items.reduce((s,i)=>s+(i.vgv||0),0);

    colEl.innerHTML = `
      <div class="col-header">
        <h3>${col.label}</h3>
        <div class="meta">
          <div style="font-size:0.9rem;color:#374151">Total:</div>
          <div class="count-value">${totalCount}</div>
        </div>
        <div class="vgv-total" title="Soma VGV">${formatCurrencyBRL(totalVgv)}</div>
      </div>
      <div class="col-content" data-col="${col.key}"></div>
    `;
    pipelineRoot.appendChild(colEl);

    const content = colEl.querySelector('.col-content');

    // group by currentGroupBy (PROJETO or GERENTE)
    const groups = {};
    items.forEach(it => {
      const key = currentGroupBy === 'GERENTE' ? it.gerente : it.projeto;
      if (!groups[key]) groups[key] = { items: [], vgv: 0, count: 0 };
      groups[key].items.push(it);
      groups[key].vgv += it.vgv || 0;
      groups[key].count += 1;
    });

    // sort groups by vgv desc
    const groupKeys = Object.keys(groups).sort((a,b) => groups[b].vgv - groups[a].vgv);

    if (!groupKeys.length) {
      content.innerHTML = '<div style="padding:8px;color:#6b7280">Sem itens nesta coluna.</div>';
      return;
    }

    groupKeys.forEach(gk=>{
      const g = groups[gk];
      const gEl = document.createElement('div');
      gEl.className = 'group';
      gEl.innerHTML = `<h4>${escapeHtml(gk)} <span class="group-meta">${g.count} • ${formatCurrencyBRL(g.vgv)}</span></h4>`;
      const list = document.createElement('div');

      // items inside group
      g.items.forEach(it=>{
        const itemEl = document.createElement('div');
        itemEl.className = 'item ' + (it.status ? it.status.toLowerCase() : 'tratativa');
        itemEl.innerHTML = `
          <div class="left" title="${escapeAttr(it.unidade)}">${escapeHtml(it.unidade)}</div>
          <div class="right">
            <div class="badge-origin" title="Origem">${escapeHtml(it.origem)}</div>
            <div class="vgv-chip" title="VGV">${formatCurrencyBRL(it.vgv)}</div>
            <div style="width:6px"></div>
            <div style="cursor:pointer" class="info-btn" data-tooltip="${escapeAttr(it.tooltip || buildTooltipText(it))}" aria-label="info"><i class="fas fa-info-circle"></i></div>
          </div>
        `;
        // attach tooltip on hover to info-btn
        const infoBtn = itemEl.querySelector('.info-btn');
        infoBtn.addEventListener('mouseenter', (e)=>{
          const t = e.currentTarget.getAttribute('data-tooltip') || '';
          showTooltip(t, e.currentTarget);
        });
        infoBtn.addEventListener('mouseleave', (e)=>{
          hideTooltip();
        });

        list.appendChild(itemEl);
      });

      gEl.appendChild(list);
      content.appendChild(gEl);
    });
  });
}

/* build a readable tooltip fallback */
function buildTooltipText(item){
  const parts = [];
  if (item.projeto) parts.push('Projeto: ' + item.projeto);
  if (item.gerente) parts.push('Gerente: ' + item.gerente);
  if (item.origem) parts.push('Origem: ' + item.origem);
  if (item.vgv) parts.push('VGV: ' + formatCurrencyBRL(item.vgv));
  return parts.join(' • ');
}

/* tooltip helpers */
function showTooltip(html, target){
  tooltip.innerHTML = html || '';
  tooltip.style.display = 'block';
  const rect = target.getBoundingClientRect();
  const ttRect = tooltip.getBoundingClientRect();
  const top = window.scrollY + rect.top - ttRect.height - 10;
  let left = window.scrollX + rect.left;
  // try to center
  left = left - (ttRect.width/2) + (rect.width/2);
  if (left < 8) left = 8;
  tooltip.style.top = top + 'px';
  tooltip.style.left = left + 'px';
}
function hideTooltip(){ tooltip.style.display = 'none'; }

/* small escaping */
function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ if (s==null) return ''; return String(s).replace(/"/g,'&quot;').replace(/'/g,"&#39;"); }

/* ---------- tabs handlers ---------- */
document.getElementById('tab-produto').addEventListener('click', ()=>{
  setActiveTab('PROJETO','tab-produto','tab-gerente');
});
document.getElementById('tab-gerente').addEventListener('click', ()=>{
  setActiveTab('GERENTE','tab-gerente','tab-produto');
});

function setActiveTab(groupBy, activeId, otherId){
  currentGroupBy = groupBy;
  document.getElementById(activeId).classList.add('active');
  document.getElementById(otherId).classList.remove('active');
  // re-render with lastRawData filtered for PARCERIAS
  const filtered = lastRawData.filter(row=>{
    const emp = row['EMPRESA'] || row['Empresa'] || row['empresa'] || row['DIRETORIA'] || '';
    return String(emp).toUpperCase().includes(FILTER_EMPRESA.toUpperCase());
  });
  renderPipeline(filtered);
}

/* ---------- refresh/export ---------- */
document.getElementById('refreshBtn').addEventListener('click', ()=>{ loadAndRender(); });
document.getElementById('downloadBtn').addEventListener('click', ()=>{ downloadFilteredCSV(); });

function downloadFilteredCSV(){
  if (!lastRawData || !lastRawData.length) { alert('Nenhum dado carregado.'); return; }
  // build csv from lastRawData but keep only PARCERIAS rows
  const rows = lastRawData.filter(row => {
    const emp = row['EMPRESA'] || row['Empresa'] || row['empresa'] || row['DIRETORIA'] || '';
    return String(emp).toUpperCase().includes(FILTER_EMPRESA.toUpperCase());
  });
  if (!rows.length){ alert('Nenhum registro PARCERIAS para exportar.'); return; }
  // infer headers from first object keys
  const headers = Object.keys(rows[0]).filter(k => isNaN(k)); // avoid numeric keys
  const lines = [headers.join(',')];
  rows.forEach(r=>{
    const vals = headers.map(h => `"${String(r[h] || '').replace(/"/g,'""')}"`);
    lines.push(vals.join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pipeline_parcerias_filtrado.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ---------- init ---------- */
loadAndRender();

/* hide tooltip on scroll/click */
window.addEventListener('scroll', hideTooltip);
window.addEventListener('click', hideTooltip);
</script>
</body>
</html>
