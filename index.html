<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard de Pipeline Comercial - Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --border: #e5e7eb;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background:#f3f4f6; color:var(--dark); }
        .container { max-width:1400px; margin:0 auto; padding:20px; }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:20px; }
        .logo { font-size:24px; font-weight:700; color:var(--primary); display:flex; gap:10px; align-items:center; }
        .tabs { display:flex; gap:10px; flex-wrap:wrap; }
        .tab { padding:10px 20px; border-radius:8px; cursor:pointer; border:1px solid var(--border); background:white; }
        .tab.active { background:var(--primary); color:white; border-color:var(--primary); }
        .tab[data-target="resumo-mes"], .tab[data-target="historico-mes"] { display:none !important; } /* ocultadas conforme solicitado */
        .dashboard { display:none; }
        .dashboard.active { display:block; }
        .filter-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:25px; padding:20px; background:white; border-radius:12px; box-shadow:var(--card-shadow); }
        .filter-group { display:flex; flex-direction:column; gap:8px; }
        .filter-input, .filter-select { padding:10px 12px; border:1px solid var(--border); border-radius:6px; }
        .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; margin-bottom:30px; }
        .metric-card { background:white; border-radius:12px; padding:20px; box-shadow:var(--card-shadow); }
        .metric-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
        .metric-content strong { display:block; font-size:1.5rem; font-weight:700; margin-top:8px; }
        .diretoria-badge { padding:4px 8px; border-radius:6px; font-weight:600; color:white; }
        .diretoria-store { background:#6366f1; color:#1f2937 !important; }
        .diretoria-sell { background:#06b6d4; color:#1f2937 !important; }
        .diretoria-homesphere { background:#10b981; }
        .diretoria-parcerias { background:#f59e0b; color:#1f2937; }
        .diretoria-ferrari { background:#ef4444; }
        .timeline-container { display:flex; gap:20px; overflow-x:auto; padding-bottom:10px; margin-bottom:30px; }
        .timeline-card { width:300px; background:white; border-radius:12px; padding:20px; box-shadow:var(--card-shadow); }
        .cards-performance { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; margin-top:16px; }
        .card-performance { background:white; padding:18px; border-radius:12px; box-shadow:var(--card-shadow); }
        .charts-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; margin-bottom:30px; }
        .chart-card { background:white; padding:20px; border-radius:12px; box-shadow:var(--card-shadow); }
        .table-container { background:white; border-radius:12px; box-shadow:var(--card-shadow); overflow:hidden; }
        .table-header { padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .atendimentos-table { width:100%; border-collapse:collapse; }
        .atendimentos-table th, .atendimentos-table td { padding:12px 16px; border-bottom:1px solid var(--border); text-align:left; }
        .pipeline-container { display:flex; gap:20px; overflow-x:auto; padding-bottom:10px; }
        .pipeline-col { flex:0 0 320px; background:white; border-radius:12px; box-shadow:var(--card-shadow); }
        .col-header { padding:15px; border-bottom:2px solid var(--border); background:#fafafa; }
        .col-content { padding:10px; max-height:60vh; overflow:auto; }
        .tratativa-row { padding:8px; border-radius:6px; background:white; border:1px solid var(--border); margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
        @media (max-width:768px){ .charts-container{grid-template-columns:1fr;} .metrics-grid{grid-template-columns:1fr;} }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo"><i class="fas fa-chart-line"></i><span>Pipeline Comercial</span></div>
        <div class="tabs">
            <div class="tab active" data-target="resumo">Resumo da Semana</div>
            <div class="tab" data-target="resumo-mes">Resumo do Mês</div>
            <div class="tab" data-target="historico-mes">Histórico Mensal</div>
            <div class="tab" data-target="panorama-estoque">Panorama Estoque</div>
            <div class="tab" data-target="controle-atendimentos">Controle de Atendimentos</div>
            <div class="tab" data-target="tratativas">Pipeline de Tratativas</div>
        </div>
    </header>

    <div id="statusArea"></div>

    <!-- Resumo da Semana -->
    <div id="resumo" class="dashboard active">
        <div class="dashboard-header">
            <h1 class="dashboard-title"><i class="fas fa-bullhorn" style="color:#f59e0b"></i> Resumo da Semana</h1>
            <p class="dashboard-subtitle" id="resumoPeriodo">Carregando período...</p>
        </div>

        <div class="filter-container">
            <div class="filter-group"><label for="resumoDataInicio">Data Início</label><input type="date" id="resumoDataInicio" class="filter-input"></div>
            <div class="filter-group"><label for="resumoDataFim">Data Fim</label><input type="date" id="resumoDataFim" class="filter-input"></div>
            <div class="filter-actions" style="display:flex; align-items:flex-end; gap:8px;">
                <button class="btn btn-primary" onclick="aplicarFiltroResumo()"><i class="fas fa-filter"></i> Aplicar Filtro</button>
                <button class="btn btn-secondary" onclick="definirSemanaAtual()"><i class="fas fa-calendar-week"></i> Semana Atual</button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#3b82f6"><i class="fas fa-door-open"></i></div><h3>Visitas</h3></div>
                <div class="metric-content"><p>Total de visitas:</p><strong id="resumoVisitas">0</strong><p class="info-text" id="resumoVisitasDetalhe">Carregando...</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#6366f1"><i class="fas fa-user-friends"></i></div><h3>Indicações</h3></div>
                <div class="metric-content"><p>Total de indicações:</p><strong id="resumoIndicacoes">0</strong><p class="info-text" id="resumoIndicacoesDetalhe">Carregando...</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#f59e0b"><i class="fas fa-reply"></i></div><h3>Retornos</h3></div>
                <div class="metric-content"><p>Retornos na semana:</p><strong id="resumoRetornos">0</strong><p class="info-text" id="resumoRetornosDetalhe">Carregando...</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#ef4444"><i class="fas fa-file-invoice-dollar"></i></div><h3>Propostas</h3></div>
                <div class="metric-content"><p>Propostas geradas:</p><strong id="resumoPropostas">0</strong><p class="info-text" id="resumoPropostasDetalhe">Carregando...</p></div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria</h4>
                <div class="chart-container"><canvas id="chartDiretoriaSemana"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento</h4><div class="chart-container"><canvas id="chartTipoAtendimento"></canvas></div></div>
        </div>

        <h2 class="timeline-header">Origem dos Clientes</h2>
        <div class="timeline-container" id="timelineOrigem"><div class="timeline-card"><div class="loading">Aguarde...</div></div></div>

        <section class="cards-performance-section">
            <h2>Performance por Diretoria</h2>
            <div class="cards-performance" id="cardsPerformanceSemanal"></div>
        </section>
    </div>

    <!-- Resumo do Mês (oculto) -->
    <div id="resumo-mes" class="dashboard">
        <!-- Mantido estático como referência -->
        <div class="dashboard-header"><h1 class="dashboard-title"><i class="fas fa-calendar-alt" style="color:#10b981"></i> Resumo do Mês</h1></div>
        <div class="metrics-grid">
            <div class="metric-card"><div class="metric-header"><h3>Visitas Espontâneas</h3></div><div class="metric-content"><p>Total de visitas:</p><strong>7</strong><p class="info-text">Store: 6 / Sell: 0 / Homesphere: 1</p></div></div>
        </div>
    </div>

    <!-- Histórico Mensal (oculto) -->
    <div id="historico-mes" class="dashboard">
        <div class="dashboard-header"><h1 class="dashboard-title"><i class="fas fa-history" style="color:#8b5cf6"></i> Histórico Mensal</h1></div>
    </div>

    <!-- Panorama Estoque: RESTAURADO ao formato original (estático neste momento) -->
    <div id="panorama-estoque" class="dashboard">
        <div class="dashboard-header"><h1 class="dashboard-title"><i class="fas fa-boxes" style="color:#8b5cf6"></i> Panorama Estoque</h1></div>
        <div class="metrics-grid">
            <div class="metric-card"><div class="metric-header"><h3>Performance Unidades</h3></div><div class="metric-content"><p>Meta 2025: 28 unidades</p><strong>15 unidades</strong><p class="info-text">53.6% de atingimento</p></div></div>
            <div class="metric-card"><div class="metric-header"><h3>Performance VGV</h3></div><div class="metric-content"><p>Meta 2025: R$ 320M</p><strong>R$ 172.4M</strong><p class="info-text">53.8% de atingimento</p></div></div>
            <div class="metric-card"><div class="metric-header"><h3>Outubro 2025</h3></div><div class="metric-content"><p>Meta: 5 unidades</p><strong>2 unidades</strong><p class="info-text">40% de atingimento</p></div></div>
            <div class="metric-card"><div class="metric-header"><h3>Estoque Total</h3></div><div class="metric-content"><p>Unidades disponíveis:</p><strong>41 unidades</strong><p class="info-text">De 56 unidades totais</p></div></div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Vendas por Torre</h4><div class="chart-container"><canvas id="chartVendasTorre"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Origem das Vendas</h4><div class="chart-container"><canvas id="chartOrigemVendas"></canvas></div></div>
        </div>

        <div class="timeline-container">
            <div class="timeline-card"><h4><i class="fas fa-check-circle" style="color:#10b981"></i> UNIDADES VENDIDAS</h4>
                <h5>Total: 15 unidades</h5>
                <div class="list-group"><h5>Por Torre</h5><ul><li>JARDINS: 4 unidades</li><li>EUROPA: 7 unidades</li><li>PARQUE: 4 unidades</li></ul></div>
                <div class="list-group"><h5>Por Metragem</h5><ul><li>387m²: 8 unidades</li><li>300m²: 7 unidades</li></ul></div>
                <div class="list-group"><h5>Por Origem</h5><ul><li>ONLINE: 5 unidades</li><li>CARTEIRA: 4 unidades</li><li>VEZ: 2 unidades</li><li>DIRETORIA: 4 unidades</li></ul></div>
            </div>

            <div class="timeline-card"><h4><i class="fas fa-warehouse" style="color:#3b82f6"></i> ESTOQUE ATUAL</h4>
                <h5>Total: 56 unidades (41 disponíveis)</h5>
                <div class="list-group"><h5>Torre Jardins</h5><ul><li>1 Garden</li><li>12 Tipos 387m²</li><li>1 Cobertura</li><li style="color:#10b981;font-weight:700">Vendidas: 4 unidades</li></ul></div>
            </div>

            <div class="timeline-card"><h4><i class="fas fa-trophy" style="color:#f59e0b"></i> PERFORMANCE 2025</h4>
                <div class="list-group"><h5>Unidades</h5><ul><li>Meta: 28 unidades</li><li>Realizado: 15 unidades</li><li style="color:#10b981;font-weight:700">Atingimento: 53.6%</li></ul></div>
            </div>
        </div>
    </div>

    <!-- Controle de Atendimentos: filtrar sempre mês vigente -->
    <div id="controle-atendimentos" class="dashboard">
        <div class="dashboard-header"><h1 class="dashboard-title"><i class="fas fa-calendar-check" style="color:#3b82f6"></i> Controle de Atendimentos</h1></div>
        <div class="filter-container">
            <div class="filter-group"><label for="filterDataInicio">Data Início</label><input type="date" id="filterDataInicio" class="filter-input"></div>
            <div class="filter-group"><label for="filterDataFim">Data Fim</label><input type="date" id="filterDataFim" class="filter-input"></div>
            <div class="filter-group"><label for="filterDiretoria">Diretoria</label><select id="filterDiretoria" class="filter-select"><option value="todas">Todas as Directorias</option><option>YUNY STORE</option><option>HOMESPHERE</option><option>PARCERIAS</option><option>DIRETORIA</option><option>YUNY SELL</option></select></div>
            <div class="filter-group"><label for="filterTipo">Tipo de Visita</label><select id="filterTipo" class="filter-select"><option value="todos">Todos os Tipos</option><option>Vez</option><option>Indicação</option><option>Retorno</option><option>Ligação</option></select></div>
            <div class="filter-actions" style="display:flex; align-items:flex-end; gap:8px;"><button class="btn btn-primary" onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Aplicar Filtros</button><button class="btn btn-secondary" onclick="limparFiltros()"><i class="fas fa-undo"></i> Limpar</button></div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card"><div class="metric-header"><h3>Total de Atendimentos</h3></div><div class="metric-content"><strong id="totalAtendimentos">0</strong></div></div>
            <div class="metric-card"><div class="metric-header"><h3>YUNY STORE</h3></div><div class="metric-content"><strong id="totalStore">0</strong></div></div>
            <div class="metric-card"><div class="metric-header"><h3>HOMESPHERE</h3></div><div class="metric-content"><strong id="totalHomesphere">0</strong></div></div>
            <div class="metric-card"><div class="metric-header"><h3>PARCERIAS</h3></div><div class="metric-content"><strong id="totalParcerias">0</strong></div></div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4>Atendimentos por Diretoria</h4><div class="chart-container"><canvas id="chartDiretoriaAtendimentos"></canvas></div></div>
            <div class="chart-card"><h4>Atendimentos por Tipo</h4><div class="chart-container"><canvas id="chartTipoAtendimentos"></canvas></div></div>
        </div>

        <div class="table-container">
            <div class="table-header"><h3 class="table-title">Registro de Atendimentos</h3><div class="table-actions"><input id="searchInput" class="search-box" placeholder="Buscar..." onkeyup="filtrarTabela()"><button class="btn btn-secondary" onclick="limparBusca()"><i class="fas fa-times"></i> Limpar</button></div></div>
            <div class="table-responsive"><table class="atendimentos-table"><thead><tr><th>Data</th><th>Tipo de Visita</th><th>Corretor</th><th>Gerente</th><th>Empresa</th></tr></thead><tbody id="tabelaAtendimentos"><tr><td colspan="5" class="loading">Carregando...</td></tr></tbody></table></div>
            <div style="padding:12px; display:flex; justify-content:space-between; align-items:center;"><div id="paginationInfo">Mostrando 0 de 0</div><div><button class="btn" onclick="mudarPagina(-1)" id="btnPrev">Anterior</button><button class="btn" onclick="mudarPagina(1)" id="btnNext">Próxima</button></div></div>
        </div>
    </div>

    <!-- Pipeline: RESTAURADO ao estado original (sem soma de VGV e sem subdivisões extras) -->
    <div id="tratativas" class="dashboard">
        <div class="header-pipeline"><h1 class="dashboard-title"><i class="fas fa-filter" style="color:#3b82f6"></i> Pipeline de Tratativas</h1><p class="dashboard-subtitle">Visão do funil</p></div>
        <div class="pipeline-container">
            <div class="pipeline-col"><div class="col-header"><h3>Unidades</h3></div><div class="col-content" id="pipelineList"></div></div>
        </div>
    </div>
</div>

<script>
// JS essencial - mantive nomes de colunas e URLs originais do seu arquivo
const SHEET_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTx2cJTokag2KDlpWxGK5V3yk3hFehgxUrVIw9vll3ES4SduXdYTLQLtKDjWQUdCvkLa3M0teXdxeEc/pub?gid=0&single=true&output=csv';
const PIPELINE_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSWVGFr4bPew5Q4j3mo2QLY2tPgNSDFjZ4T40X3-D8bnWwIPKnHf_nhvWE34WMRJEqGYqD3e3hnKvDz/pub?gid=0&single=true&output=csv';

const COL_DATA = 'Data';
const COL_TIPO = 'TIPO DE VISITA';
const COL_DIRETORIA = 'Empresa';
const COL_MIDIA = 'Mídia';

let atendimentosData = [];
let dadosResumoFiltrados = [];
let atendimentosFiltrados = [];
let paginaAtual = 1;
const itensPorPagina = 10;

let chartDiretoriaSemana = null;
let chartTipoAtendimentoSemana = null;
let chartDiretoriaAtendimentos = null;
let chartTipoAtendimentos = null;

// utils
function parseDate(dateStr){ if(!dateStr) return null; const parts = dateStr.split('/'); if(parts.length===3) return new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00`); if(dateStr.includes('-')) return new Date(dateStr+'T00:00:00'); return null; }
function normalizeText(v){ if(v===undefined||v===null) return 'NÃO INFORMADA'; return String(v).trim().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase(); }
function csvToJson(csv){ const lines = csv.split('\n').filter(l=>l.trim()!==''); if(lines.length<=1) return {data:[], headersFound:{}}; const first = lines[0]; let delimiter = first.includes(';')?';':(first.includes('\t')?'\t':','); const headers = first.split(delimiter).map(h=>h.trim().replace(/"/g,'')); const norm = headers.map(h=>h.toUpperCase()); const res=[]; const headersFound={}; const expected=[COL_DATA,COL_TIPO,COL_DIRETORIA,COL_MIDIA]; const headerIndex={}; expected.forEach(e=>{ const idx = norm.findIndex(n=>n===e.toUpperCase()); if(idx!==-1){ headerIndex[e]=idx; headersFound[e]=true; } }); for(let i=1;i<lines.length;i++){ const row = lines[i].trim(); if(!row) continue; const cols = row.split(delimiter); const obj={}; let empty=true; for(const e of expected){ const idx = headerIndex[e]; if(idx!==undefined && cols.length>idx){ let v=cols[idx]||''; v=v.trim().replace(/^"|"$/g,'').replace(/""/g,'"'); obj[e]=v; if(v.length>0) empty=false; } } if(!empty) res.push(obj); } return {data:res, headersFound}; }

async function carregarDados(){
    const status = document.getElementById('statusArea');
    if(status) status.innerHTML = '<div class="loading">Carregando dados...</div>';
    try {
        const r = await fetch(SHEET_DATA_URL);
        if(!r.ok) throw new Error(r.statusText);
        const txt = await r.text();
        const {data, headersFound} = csvToJson(txt);
        atendimentosData = data;
        atendimentosFiltrados = atendimentosData.slice();
        if(status) status.innerHTML = `<div class="success-message">Atendimentos carregados: ${atendimentosData.length}</div>`;
        // set default controle de atendimentos para mês atual
        definirMesAtualControle();
        // initialize resumo week
        definirSemanaAtual();
    } catch(e){
        console.error(e);
        const status = document.getElementById('statusArea');
        if(status) status.innerHTML = `<div class="error-message">Erro ao carregar planilha: ${e.message}</div>`;
    }
}

function definirSemanaAtual(){
    const hoje = new Date(); const dia = hoje.getDay();
    const segunda = new Date(hoje); segunda.setDate(hoje.getDate() - (dia===0?6:dia-1));
    const domingo = new Date(segunda); domingo.setDate(segunda.getDate()+6);
    document.getElementById('resumoDataInicio').value = segunda.toISOString().split('T')[0];
    document.getElementById('resumoDataFim').value = domingo.toISOString().split('T')[0];
    aplicarFiltroResumo();
}

function definirMesAtualControle(){
    const hoje = new Date();
    const primeiro = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    const ultimo = new Date(hoje.getFullYear(), hoje.getMonth()+1, 0);
    const inEl = document.getElementById('filterDataInicio');
    const fnEl = document.getElementById('filterDataFim');
    if(inEl && fnEl){
        inEl.value = primeiro.toISOString().split('T')[0];
        fnEl.value = ultimo.toISOString().split('T')[0];
    }
    // aplicar filtros automaticamente
    aplicarFiltros();
}

function aplicarFiltroResumo(){
    const inicio = document.getElementById('resumoDataInicio').value;
    const fim = document.getElementById('resumoDataFim').value;
    if(!inicio || !fim) return;
    const di = new Date(inicio+'T00:00:00'); const df = new Date(fim+'T23:59:59');
    dadosResumoFiltrados = atendimentosData.filter(i=>{ const d=parseDate(i[COL_DATA]); if(!d) return false; return d>=di && d<=df; });
    atualizarResumoPeriodo(di, df);
    calcularMetricasResumo();
    inicializarGraficosResumo();
    atualizarTimelineOrigem();
    atualizarCardsPerformanceSemanal();
}

function atualizarResumoPeriodo(inicio,fim){
    const opt={day:'2-digit',month:'2-digit',year:'numeric'};
    document.getElementById('resumoPeriodo').textContent = `Período: ${inicio.toLocaleDateString('pt-BR',opt)} a ${fim.toLocaleDateString('pt-BR',opt)}`;
}

// calcular métricas (visitas, indicacoes, retornos, propostas)
function calcularMetricasResumo(){
    const diretorias = {};
    dadosResumoFiltrados.forEach(item=>{
        const dirRaw = item[COL_DIRETORIA] || 'NÃO INFORMADA';
        const key = normalizeText(dirRaw);
        if(!diretorias[key]) diretorias[key] = { label: dirRaw, visitas:0, indicacoes:0, retornos:0, propostas:0 };
        const tipo = (item[COL_TIPO]||'').toUpperCase();
        if(tipo.includes('VEZ')) diretorias[key].visitas++;
        else if(tipo.includes('INDI')) diretorias[key].indicacoes++;
        else if(tipo.includes('RETORNO')) diretorias[key].retornos++;
        else if(tipo.includes('PROPOSTA')) diretorias[key].propostas++;
    });

    const totals = { visitas:0, indicacoes:0, retornos:0, propostas:0 };
    Object.values(diretorias).forEach(d=>{ totals.visitas+=d.visitas; totals.indicacoes+=d.indicacoes; totals.retornoes=(totals.retornoes||0)+d.retornos; totals.propostas+=d.propostas; });

    document.getElementById('resumoVisitas').textContent = totals.visitas;
    document.getElementById('resumoIndicacoes').textContent = totals.indicacoes;
    document.getElementById('resumoRetornos').textContent = (totals.retornoes||0);
    document.getElementById('resumoPropostas').textContent = totals.propostas;

    function detalhe(field){ const arr=[]; for(const k in diretorias){ const v=diretorias[k][field]||0; if(v>0) arr.push(`${diretorias[k].label}: ${v}`); } return arr.join(' / ') || 'Nenhuma diretoria'; }
    const dv = document.getElementById('resumoVisitasDetalhe'); if(dv) dv.textContent = detalhe('visitas');
    const di = document.getElementById('resumoIndicacoesDetalhe'); if(di) di.textContent = detalhe('indicacoes');
    const dr = document.getElementById('resumoRetornosDetalhe'); if(dr) dr.textContent = detalhe('retornos');
    const dp = document.getElementById('resumoPropostasDetalhe'); if(dp) dp.textContent = detalhe('propostas');
}

// charts resumo
function inicializarGraficosResumo(){
    // Distribuição por diretoria - estilo restaurado: doughnut com legend bottom
    const cont = {};
    dadosResumoFiltrados.forEach(i=>{ const d=(i[COL_DIRETORIA]||'NÃO INFORMADA').trim().toUpperCase(); cont[d]=(cont[d]||0)+1; });
    const labels = Object.keys(cont); const data = labels.map(l=>cont[l]);
    const ctx = document.getElementById('chartDiretoriaSemana');
    if(ctx){
        if(chartDiretoriaSemana) chartDiretoriaSemana.destroy();
        chartDiretoriaSemana = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data }] }, options:{ plugins:{ legend:{ position:'bottom' } }, cutout:'50%' } });
    }

    // tipo atendimento
    const tcont = {};
    dadosResumoFiltrados.forEach(i=>{ const t=(i[COL_TIPO]||'NÃO INFORMADO').toUpperCase(); tcont[t]=(tcont[t]||0)+1; });
    const labels2 = Object.keys(tcont); const data2 = labels2.map(l=>tcont[l]);
    const ctx2 = document.getElementById('chartTipoAtendimento');
    if(ctx2){
        if(chartTipoAtendimentoSemana) chartTipoAtendimentoSemana.destroy();
        chartTipoAtendimentoSemana = new Chart(ctx2, { type:'bar', data:{ labels:labels2, datasets:[{ data:data2 }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
    }
}

// timeline origem (simples)
function atualizarTimelineOrigem(){
    const container = document.getElementById('timelineOrigem'); if(!container) return; container.innerHTML = '';
    const visitas = {}, indic = {}, ret = {};
    dadosResumoFiltrados.forEach(item=>{ const t=(item[COL_TIPO]||'').toUpperCase(); const m = normalizeText(item[COL_MIDIA]||'NÃO INFORMADA'); if(t.includes('VEZ')) visitas[m]=(visitas[m]||0)+1; else if(t.includes('INDI')) indic[m]=(indic[m]||0)+1; else if(t.includes('RETORNO')) ret[m]=(ret[m]||0)+1; });
    function criar(titulo,sub,map){ if(!map||Object.keys(map).length===0) return null; const total=Object.values(map).reduce((a,b)=>a+b,0); const card=document.createElement('div'); card.className='timeline-card'; card.innerHTML=`<h4>${titulo}</h4><h5>${sub}</h5><p>Total: ${total}</p><ul>${Object.entries(map).map(([k,v])=>`<li>${k}: ${v}</li>`).join('')}</ul>`; return card; }
    const c1=criar('Visitas','Origem das Visitas',visitas); const c2=criar('Indicações','Origem das Indicações',indic); const c3=criar('Retornos','Origem dos Retornos',ret);
    if(c1) container.appendChild(c1); if(c2) container.appendChild(c2); if(c3) container.appendChild(c3);
    if(container.children.length===0) container.innerHTML='<div class="timeline-card">Nenhum dado de origem para o período.</div>';
}

// atualizar cards performance (formato pedido)
function atualizarCardsPerformanceSemanal(){
    const container = document.getElementById('cardsPerformanceSemanal'); if(!container) return; container.innerHTML='';
    const grupos = {};
    dadosResumoFiltrados.forEach(item=>{
        const raw = item[COL_DIRETORIA] || 'NÃO INFORMADA'; const key = normalizeText(raw);
        if(!grupos[key]) grupos[key] = { label: raw, visitas:0, indicacoes:0, retornos:0, propostas:0 };
        const t = (item[COL_TIPO]||'').toUpperCase();
        if(t.includes('VEZ')) grupos[key].visitas++;
        else if(t.includes('INDI')) grupos[key].indicacoes++;
        else if(t.includes('RETORNO')) grupos[key].retornos++;
        else if(t.includes('PROPOSTA')) grupos[key].propostas++;
    });
    function cls(k){ if(k.includes('STORE')) return 'store'; if(k.includes('SELL')||k.includes('YUNYSELL')) return 'sell'; if(k.includes('HOMESPHERE')) return 'homesphere'; if(k.includes('PARCERIA')) return 'parcerias'; if(k.includes('FERRARI')) return 'ferrari'; return ''; }
    for(const k in grupos){ const g=grupos[k]; const total = g.visitas+g.indicacoes+g.retornos+g.propostas; const card=document.createElement('div'); card.className='card-performance '+cls(k); card.innerHTML=`<h3>${g.label}</h3><p style="font-weight:600;color:#666;margin-top:6px;">Performance do Mês</p><p>Visitas: <strong>${g.visitas}</strong></p><p>Indicações: <strong>${g.indicacoes}</strong></p><p>Retornos: <strong>${g.retornos}</strong></p><p>Propostas: <strong>${g.propostas}</strong></p><p style="margin-top:8px;">Total: <strong>${total}</strong></p>`; container.appendChild(card); }
    if(Object.keys(grupos).length===0) container.innerHTML='<div class="loading">Nenhum dado encontrado no período selecionado.</div>';
}

// Controle de atendimentos: filtros, tabela, paginação e gráficos
function aplicarFiltros(){
    const inicio = document.getElementById('filterDataInicio').value;
    const fim = document.getElementById('filterDataFim').value;
    const diretoria = document.getElementById('filterDiretoria').value;
    const tipo = document.getElementById('filterTipo').value;
    atendimentosFiltrados = atendimentosData.filter(item=>{
        const d=parseDate(item[COL_DATA]); if(!d) return false;
        if(inicio){ const si=new Date(inicio+'T00:00:00'); if(d<si) return false; } if(fim){ const sf=new Date(fim+'T23:59:59'); if(d>sf) return false; }
        if(diretoria && diretoria!=='todas'){ if(!((item[COL_DIRETORIA]||'').toUpperCase().includes(diretoria.toUpperCase()))) return false; }
        if(tipo && tipo!=='todos'){ if(!((item[COL_TIPO]||'').toUpperCase().includes(tipo.toUpperCase()))) return false; }
        return true;
    });
    paginaAtual=1; montarTabelaAtendimentos();
}

function limparFiltros(){
    document.getElementById('filterDataInicio').value=''; document.getElementById('filterDataFim').value=''; document.getElementById('filterDiretoria').value='todas'; document.getElementById('filterTipo').value='todos';
    atendimentosFiltrados = atendimentosData.slice(); paginaAtual=1; montarTabelaAtendimentos();
}

function montarTabelaAtendimentos(){
    const tbody = document.getElementById('tabelaAtendimentos'); if(!tbody) return; tbody.innerHTML='';
    const start = (paginaAtual-1)*itensPorPagina; const pageItems = atendimentosFiltrados.slice(start, start+itensPorPagina);
    if(pageItems.length===0) tbody.innerHTML='<tr><td colspan="5">Nenhum registro encontrado.</td></tr>';
    else{
        pageItems.forEach(r=>{
            const tr=document.createElement('tr'); const tdData=document.createElement('td'); tdData.textContent=r[COL_DATA]||''; tr.appendChild(tdData);
            const tdTipo=document.createElement('td'); tdTipo.textContent=r[COL_TIPO]||''; tr.appendChild(tdTipo);
            const tdCor=document.createElement('td'); tdCor.textContent=r['Corretor de atendimento']||''; tr.appendChild(tdCor);
            const tdGer=document.createElement('td'); tdGer.textContent=r['Gerente']||''; tr.appendChild(tdGer);
            const tdEmp=document.createElement('td'); const span=document.createElement('span'); span.className='diretoria-badge';
            const emp = r[COL_DIRETORIA]||'NÃO INFORMADA'; const up=emp.toUpperCase();
            if(up.includes('STORE')) span.classList.add('diretoria-store'); else if(up.includes('HOMESPHERE')) span.classList.add('diretoria-homesphere'); else if(up.includes('PARCERIAS')) span.classList.add('diretoria-parcerias'); else if(up.includes('FERRARI')) span.classList.add('diretoria-ferrari'); else if(up.includes('SELL')||up.includes('YUNYSELL')) span.classList.add('diretoria-sell');
            span.textContent = emp; tdEmp.appendChild(span); tr.appendChild(tdEmp);
            tbody.appendChild(tr);
        });
    }
    const pgInfo = document.getElementById('paginationInfo'); if(pgInfo) pgInfo.textContent = `Mostrando ${Math.min(atendimentosFiltrados.length,start+1)} até ${Math.min(atendimentosFiltrados.length,start+pageItems.length)} de ${atendimentosFiltrados.length}`;
    document.getElementById('totalAtendimentos').textContent = atendimentosFiltrados.length;
    document.getElementById('totalStore').textContent = atendimentosFiltrados.filter(i=> (i[COL_DIRETORIA]||'').toUpperCase().includes('STORE')).length;
    document.getElementById('totalHomesphere').textContent = atendimentosFiltrados.filter(i=> (i[COL_DIRETORIA]||'').toUpperCase().includes('HOMESPHERE')).length;
    document.getElementById('totalParcerias').textContent = atendimentosFiltrados.filter(i=> (i[COL_DIRETORIA]||'').toUpperCase().includes('PARCERIAS')).length;
    atualizarGraficosControleAtendimentos();
}

function mudarPagina(dir){ paginaAtual += dir; montarTabelaAtendimentos(); }
function filtrarTabela(){ const q=document.getElementById('searchInput').value.toLowerCase(); atendimentosFiltrados = atendimentosData.filter(r => Object.values(r).some(v=> (v||'').toString().toLowerCase().includes(q))); paginaAtual=1; montarTabelaAtendimentos(); }
function limparBusca(){ document.getElementById('searchInput').value=''; atendimentosFiltrados = atendimentosData.slice(); montarTabelaAtendimentos(); }

function atualizarGraficosControleAtendimentos(){
    const cont = {}; atendimentosFiltrados.forEach(i=>{ const d=(i[COL_DIRETORIA]||'NÃO INFORMADA').toUpperCase(); cont[d]=(cont[d]||0)+1; });
    const labels = Object.keys(cont); const vals = labels.map(l=>cont[l]); const ctx = document.getElementById('chartDiretoriaAtendimentos');
    if(ctx){ if(chartDiretoriaAtendimentos) chartDiretoriaAtendimentos.destroy(); chartDiretoriaAtendimentos = new Chart(ctx,{ type:'pie', data:{ labels, datasets:[{ data:vals }] }, options:{ plugins:{ legend:{ position:'bottom' } } } }); }
    const tcont = {}; atendimentosFiltrados.forEach(i=>{ const t=(i[COL_TIPO]||'NÃO INFORMADO').toUpperCase(); tcont[t]=(tcont[t]||0)+1; });
    const labels2 = Object.keys(tcont); const vals2 = labels2.map(l=>tcont[l]); const ctx2 = document.getElementById('chartTipoAtendimentos');
    if(ctx2){ if(chartTipoAtendimentos) chartTipoAtendimentos.destroy(); chartTipoAtendimentos = new Chart(ctx2,{ type:'bar', data:{ labels:labels2, datasets:[{ data:vals2 }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } }); }
}

// Pipeline: restore original simple list (no VGV sum)
let pipelineData = [];
async function carregarPipeline(){
    try {
        const r = await fetch(PIPELINE_DATA_URL);
        if(!r.ok) throw new Error(r.statusText);
        const txt = await r.text();
        const parsed = csvToJson(txt);
        pipelineData = parsed.data;
        popularPipelineOriginal();
    } catch(e){
        console.warn('pipeline load failed', e);
        pipelineData = [];
        popularPipelineOriginal();
    }
}
function popularPipelineOriginal(){
    const container = document.getElementById('pipelineList'); if(!container) return; container.innerHTML='';
    if(!pipelineData.length){ container.innerHTML = '<div class="loading">Nenhum dado de pipeline carregado.</div>'; return; }
    pipelineData.forEach(row=>{
        const div = document.createElement('div'); div.className='tratativa-row'; div.innerHTML = `<div>${row['UNIDADE'] || row['UNIDADE'] || ''}</div><div>${row['EMPRESA'] || row['EMPRESA'] || ''}</div>`; container.appendChild(div);
    });
}

// init & events
document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.tab').forEach(t=>{ t.addEventListener('click', ()=>{ if(getComputedStyle(t).display==='none') return; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); document.querySelectorAll('.dashboard').forEach(d=>d.classList.remove('active')); const target = t.getAttribute('data-target'); const el = document.getElementById(target); if(el) el.classList.add('active'); if(target==='controle-atendimentos'){ definirMesAtualControle(); } }); });
    carregarDados(); carregarPipeline();
});
</script>
</body>
</html>
