<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard de Pipeline Comercial - Ajustado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* === ESTILOS ORIGINAIS PRESERVADOS === */
        :root {
            --primary: #3b82f6;
            --secondary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --border: #e5e7eb;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f3f4f6; color: #1f2937; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:20px; }
        .logo { font-size:24px; font-weight:700; color:var(--primary); display:flex; align-items:center; gap:10px; }
        .tabs { display:flex; gap:10px; flex-wrap:wrap; }
        .tab { padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:500; transition:all .3s; border:1px solid var(--border); }
        .tab.active { background-color:var(--primary); color:white; border-color:var(--primary); }
        .tab:hover:not(.active){ background:#e5e7eb; }

        /* === OCULTAR abas 2 e 3 via CSS (solicitado) === */
        .tab[data-target="resumo-mes"], .tab[data-target="historico-mes"] { display: none !important; }

        .dashboard { display:none; animation:fadeIn .5s ease; }
        .dashboard.active { display:block; }
        .dashboard-header { margin-bottom:24px; }
        .dashboard-title { font-size:28px; font-weight:700; margin-bottom:8px; display:flex; align-items:center; gap:12px; }
        .dashboard-subtitle { color:var(--gray); font-size:16px; }
        .filter-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:25px; padding:20px; background:white; border-radius:12px; box-shadow:var(--card-shadow); }
        .filter-group { display:flex; flex-direction:column; gap:8px; }
        .filter-group label { font-weight:600; font-size:.9rem; color:var(--dark); display:flex; align-items:center; gap:8px; }
        .filter-select, .filter-input { padding:10px 12px; border:1px solid var(--border); border-radius:6px; background:white; font-size:.9rem; width:100%; cursor:pointer; transition:border-color .3s; }
        .filter-select:focus, .filter-input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,0.1); }
        .filter-actions { display:flex; gap:10px; align-items:flex-end; }
        .btn { padding:10px 20px; border:none; border-radius:6px; font-weight:600; cursor:pointer; transition:all .3s; display:flex; align-items:center; gap:8px; }
        .btn-primary { background-color:var(--primary); color:white; } .btn-secondary { background-color:var(--gray); color:white; } .btn-success { background-color:var(--success); color:white; }

        .table-container { background:white; border-radius:12px; box-shadow:var(--card-shadow); overflow:hidden; margin-bottom:30px; }
        .table-header { padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; }
        .table-title { font-size:1.2rem; font-weight:700; color:var(--dark); }
        .table-actions { display:flex; gap:10px; align-items:center; }
        .search-box { padding:8px 12px; border:1px solid var(--border); border-radius:6px; width:250px; }

        .atendimentos-table { width:100%; border-collapse:collapse; }
        .atendimentos-table th { background:var(--light); padding:12px 16px; text-align:left; font-weight:600; color:var(--dark); border-bottom:1px solid var(--border); white-space:nowrap; }
        .atendimentos-table td { padding:12px 16px; border-bottom:1px solid var(--border); vertical-align:middle; }

        .diretoria-badge { padding:4px 8px; border-radius:6px; font-size:.75rem; font-weight:600; color:white; }
        .diretoria-store { background-color:#6366f1; }
        .diretoria-homesphere { background-color:#10b981; }
        .diretoria-parcerias { background-color:#f59e0b; color:#1f2937; }
        .diretoria-ferrari { background-color:#ef4444; }
        .diretoria-diretoria { background-color:#8b5cf6; }
        .diretoria-sell { background-color:#06b6d4; }

        /* Correção de contraste - texto escuro onde o fundo é muito claro */
        .diretoria-store, .diretoria-sell { color:#1f2937 !important; }

        .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; margin-bottom:30px; }
        .metric-card { background:white; border-radius:12px; padding:20px; box-shadow:var(--card-shadow); transition:transform .3s ease; }
        .metric-card:hover { transform:translateY(-5px); }
        .metric-header { display:flex; align-items:center; margin-bottom:16px; gap:12px; }
        .metric-header .icon { width:40px; height:40px; background:var(--light); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; }
        .metric-header h3 { font-size:1.2rem; font-weight:600; color:var(--dark); }
        .metric-content p { font-size:1rem; color:var(--gray); margin-bottom:4px; }
        .metric-content strong { display:block; font-size:1.5rem; font-weight:700; color:var(--dark); margin-top:8px; }
        .metric-content .info-text { font-size:.8rem; color:var(--gray); margin-top:4px; }

        .timeline-header { text-align:center; font-size:24px; font-weight:700; margin-bottom:30px; }
        .timeline-container { display:flex; flex-wrap:nowrap; overflow-x:auto; gap:20px; padding-bottom:10px; margin-bottom:30px; scroll-behavior:smooth; }
        .timeline-card { flex:0 0 auto; width:300px; background:white; border-radius:12px; padding:20px; box-shadow:var(--card-shadow); }
        .timeline-card h4 { font-size:1rem; color:var(--primary); font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
        .timeline-card h5 { font-size:1.1rem; font-weight:700; margin-bottom:10px; }
        .timeline-card ul { list-style:none; padding-left:0; margin-top:10px; }
        .timeline-card ul li { position:relative; padding-left:20px; font-size:.9rem; color:var(--dark); margin-bottom:5px; }
        .timeline-card ul li:before { content:"•"; position:absolute; left:0; color:var(--primary); font-weight:bold; }

        .charts-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; margin-bottom:30px; }
        .chart-card { background:white; border-radius:12px; padding:20px; box-shadow:var(--card-shadow); }
        .chart-card h4 { font-size:1.1rem; font-weight:600; margin-bottom:15px; color:var(--dark); }
        .chart-container { position:relative; height:300px; width:100%; }

        .cards-performance { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; margin-top:16px; margin-bottom:24px; }
        .card-performance { padding:18px; border-radius:12px; background:white; box-shadow:var(--card-shadow); }
        .card-performance h3 { font-weight:700; margin-bottom:8px; font-size:1.05rem; }
        .card-performance p { margin:4px 0; color:var(--dark); }
        .card-performance.store { border-left:6px solid #6366f1; }
        .card-performance.sell { border-left:6px solid #06b6d4; }
        .card-performance.homesphere { border-left:6px solid #10b981; }
        .card-performance.parcerias { border-left:6px solid #f59e0b; }
        .card-performance.ferrari { border-left:6px solid #ef4444; }
        .card-performance.diretoria { border-left:6px solid #8b5cf6; }

        .pipeline-container { display:flex; gap:20px; overflow-x:auto; padding-bottom:10px; width:100%; }
        .pipeline-col { flex:0 0 320px; background:white; border-radius:12px; box-shadow:var(--card-shadow); display:flex; flex-direction:column; max-height:80vh; }
        .col-header { padding:15px; border-bottom:2px solid var(--border); display:flex; flex-direction:column; align-items:flex-start; background:var(--light); border-top-left-radius:12px; border-top-right-radius:12px; flex-shrink:0; }
        .col-header h3 { font-size:1.1rem; font-weight:700; margin-bottom:5px; }
        .col-header .count { display:flex; justify-content:space-between; width:100%; font-size:.9em; font-weight:600; color:var(--dark); }
        .col-header .count-value { background:var(--primary); color:white; padding:2px 8px; border-radius:999px; font-size:.8em; font-weight:600; white-space:nowrap; }

        .col-content { padding:10px; overflow-y:auto; flex-grow:1; background:#f9fafb; }
        .tratativa-row { position:relative; cursor:pointer; transition:background-color .2s; padding:6px 8px; border-radius:4px; margin-bottom:3px; background:white; border:1px solid var(--border); box-shadow:0 1px 3px rgba(0,0,0,.05); display:flex; justify-content:space-between; align-items:center; font-size:.85em; }
        .tratativa-row:hover { background-color: rgba(59,130,246,0.1); }
        .tratativa-row-vendido { border-left:5px solid var(--success); }
        .tratativa-row-processo { border-left:5px solid var(--primary); }
        .tratativa-row-proposta { border-left:5px solid var(--warning); }
        .tratativa-row-tratativa { border-left:5px solid #06b6d4; }

        .loading { text-align:center; padding:20px; color:var(--primary); }
        .error-message { background:#fef2f2; border:1px solid #fecaca; color:#dc2626; padding:15px; border-radius:8px; margin:10px 0; }
        .success-message { background:#d1fae5; border:1px solid #a7f3d0; color:#065f46; padding:15px; border-radius:8px; margin:10px 0; }
        .warning-message { background:#fef3c7; border:1px solid #f59e0b; color:#92400e; padding:15px; border-radius:8px; margin:10px 0; }

        @media (max-width:768px) {
            .filter-container { grid-template-columns:1fr; }
            .timeline-card { width:280px; }
            .metrics-grid { grid-template-columns:1fr; }
            .charts-container { grid-template-columns:1fr; }
            .table-header { flex-direction:column; align-items:stretch; }
            .search-box { width:100%; }
            .table-actions { justify-content:space-between; }
            .date-range { flex-direction:column; }
        }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo"><i class="fas fa-chart-line"></i><span>Pipeline Comercial</span></div>
        <div class="tabs">
            <div class="tab active" data-target="resumo">Resumo da Semana</div>
            <!-- abas 2 e 3 ocultas por CSS -->
            <div class="tab" data-target="resumo-mes">Resumo do Mês</div>
            <div class="tab" data-target="historico-mes">Histórico Mensal</div>
            <div class="tab" data-target="panorama-estoque">Panorama Estoque</div>
            <div class="tab" data-target="controle-atendimentos">Controle de Atendimentos</div>
            <div class="tab" data-target="tratativas">Pipeline de Tratativas</div>
        </div>
    </header>

    <div id="statusArea"></div>

    <!-- ABA 1 -->
    <div id="resumo" class="dashboard active">
        <div class="dashboard-header">
            <h1 class="dashboard-title"><i class="fas fa-bullhorn" style="color:#f59e0b"></i> Resumo da Semana</h1>
            <p class="dashboard-subtitle" id="resumoPeriodo">Carregando período...</p>
        </div>

        <div class="filter-container">
            <div class="date-range">
                <div class="filter-group"><label for="resumoDataInicio"><i class="fas fa-calendar"></i> Data Início</label><input type="date" id="resumoDataInicio" class="filter-input"></div>
                <div class="filter-group"><label for="resumoDataFim"><i class="fas fa-calendar"></i> Data Fim</label><input type="date" id="resumoDataFim" class="filter-input"></div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="aplicarFiltroResumo()"><i class="fas fa-filter"></i> Aplicar Filtro</button>
                <button class="btn btn-secondary" onclick="definirSemanaAtual()"><i class="fas fa-calendar-week"></i> Semana Atual</button>
            </div>
        </div>

        <div class="metrics-grid" id="metricsResumoSemanal">
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#3b82f6"><i class="fas fa-door-open"></i></div><h3>Visitas</h3></div>
                <div class="metric-content"><p>Total de visitas:</p><strong id="resumoVisitas">0</strong><p class="info-text" id="resumoVisitasDetalhe">Carregando...</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#6366f1"><i class="fas fa-user-friends"></i></div><h3>Indicações</h3></div>
                <div class="metric-content"><p>Total de indicações:</p><strong id="resumoIndicacoes">0</strong><p class="info-text" id="resumoIndicacoesDetalhe">Carregando...</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#f59e0b"><i class="fas fa-reply"></i></div><h3>Retornos</h3></div>
                <div class="metric-content"><p>Retornos na semana:</p><strong id="resumoRetornos">0</strong><p class="info-text" id="resumoRetornosDetalhe">Carregando...</p></div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="icon" style="color:#ef4444"><i class="fas fa-file-invoice-dollar"></i></div><h3>Propostas</h3></div>
                <div class="metric-content"><p>Propostas geradas:</p><strong id="resumoPropostas">0</strong><p class="info-text" id="resumoPropostasDetalhe">Carregando...</p></div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria</h4><div class="chart-container"><canvas id="chartDiretoriaSemana"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento</h4><div class="chart-container"><canvas id="chartTipoAtendimento"></canvas></div></div>
        </div>

        <h2 class="timeline-header">Origem dos Clientes</h2>
        <div class="timeline-container" id="timelineOrigem"><div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados de origem...</div></div>

        <!-- Cards idênticos aos do resumo mensal (dinâmicos) -->
        <section class="cards-performance-section">
          <h2>Performance por Diretoria</h2>
          <div class="cards-performance" id="cardsPerformanceSemanal"></div>
        </section>
    </div>

    <!-- ABA 2 e 3: ainda no HTML (mantidos), mas as tabs estão ocultas via CSS -->
    <div id="resumo-mes" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title"><i class="fas fa-calendar-alt" style="color:#10b981"></i> Resumo do Mês - OUTUBRO</h1>
            <p class="dashboard-subtitle">QUADDRA LORENA - Outubro/2025</p>
        </div>
        <!-- conteúdo estático mantido para referência -->
        <div class="metrics-grid">
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#3b82f6"><i class="fas fa-door-open"></i></div><h3>Visitas Espontâneas</h3></div><div class="metric-content"><p>Total de visitas:</p><strong>7</strong><p class="info-text">Store: 6 / Sell: 0 / Homesphere: 1</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#6366f1"><i class="fas fa-user-friends"></i></div><h3>Indicações Empresa</h3></div><div class="metric-content"><p>Total de indicações:</p><strong>7</strong><p class="info-text">Store: 4 / Sell: 2 / Home: 0 / Parcerias: 1</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#f59e0b"><i class="fas fa-reply"></i></div><h3>Retornos</h3></div><div class="metric-content"><p>Retornos no mês:</p><strong>2</strong><p class="info-text">Store: 1 / Sell: 0 / Home: 1 / Parcerias: 0</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#10b981"><i class="fas fa-chart-line"></i></div><h3>Total de Atendimentos</h3></div><div class="metric-content"><p>Atendimentos totais:</p><strong>16</strong><p class="info-text">Visitas + Indicações + Retornos</p></div></div>
        </div>
        <!-- ... restante mantido ... -->
    </div>

    <div id="historico-mes" class="dashboard">
        <div class="dashboard-header"><h1 class="dashboard-title"><i class="fas fa-history" style="color:#8b5cf6"></i> Histórico Mensal - SETEMBRO</h1><p class="dashboard-subtitle">Relatório Mensal - Setembro/2025</p></div>
        <!-- conteúdo mantido -->
        <div class="metrics-grid">
            <!-- (conteúdo estático omitido para brevidade no HTML, mantido original) -->
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#3b82f6"><i class="fas fa-door-open"></i></div><h3>Visitas Espontâneas</h3></div><div class="metric-content"><p>Total de visitas:</p><strong>53</strong><p class="info-text">Store: 31 / Sell: 6 / Homesphere: 16</p></div></div>
            <!-- ... -->
        </div>
    </div>

    <!-- ABA 4 -->
    <div id="panorama-estoque" class="dashboard">
        <div class="dashboard-header"><h1 class="dashboard-title"><i class="fas fa-boxes" style="color:#8b5cf6"></i> Panorama Estoque</h1><p class="dashboard-subtitle">Visão geral de vendas, estoque e performance - Quaddra Lorena</p></div>

        <div class="metrics-grid">
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#10b981"><i class="fas fa-bullseye"></i></div><h3>Performance Unidades</h3></div><div class="metric-content"><p>Meta 2025: 28 unidades</p><strong id="pan_unidades_real">--</strong><p class="info-text" id="pan_unidades_info">Carregando...</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#3b82f6"><i class="fas fa-chart-line"></i></div><h3>Performance VGV</h3></div><div class="metric-content"><p>Meta 2025: R$ 320M</p><strong id="pan_vgv_real">--</strong><p class="info-text" id="pan_vgv_info">Carregando...</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#f59e0b"><i class="fas fa-calendar-check"></i></div><h3>Outubro 2025</h3></div><div class="metric-content"><p>Meta: 5 unidades</p><strong id="pan_out_unidades">--</strong><p class="info-text" id="pan_out_info">Carregando...</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#ef4444"><i class="fas fa-box"></i></div><h3>Estoque Total</h3></div><div class="metric-content"><p>Unidades disponíveis:</p><strong id="pan_estoque">--</strong><p class="info-text" id="pan_estoque_info">Carregando...</p></div></div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Vendas por Torre</h4><div class="chart-container"><canvas id="chartVendasTorre"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Origem das Vendas</h4><div class="chart-container"><canvas id="chartOrigemVendas"></canvas></div></div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-line"></i> Performance de Atingimento</h4><div class="chart-container"><canvas id="chartPerformance"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-balance-scale"></i> Vendas vs Estoque</h4><div class="chart-container"><canvas id="chartVendasEstoque"></canvas></div></div>
        </div>
    </div>

    <!-- ABA 5 Controle de Atendimentos -->
    <div id="controle-atendimentos" class="dashboard">
        <div class="dashboard-header"><h1 class="dashboard-title"><i class="fas fa-calendar-check" style="color:#3b82f6"></i> Controle de Atendimentos</h1><p class="dashboard-subtitle">Gestão completa de visitas e atendimentos comerciais</p></div>

        <div class="filter-container">
            <div class="date-range"><div class="filter-group"><label for="filterDataInicio"><i class="fas fa-calendar"></i> Data Início</label><input type="date" id="filterDataInicio" class="filter-input"></div><div class="filter-group"><label for="filterDataFim"><i class="fas fa-calendar"></i> Data Fim</label><input type="date" id="filterDataFim" class="filter-input"></div></div>
            <div class="filter-group"><label for="filterDiretoria"><i class="fas fa-building"></i> Diretoria</label><select id="filterDiretoria" class="filter-select"><option value="todas">Todas as Directorias</option><option value="YUNY STORE">YUNY STORE</option><option value="HOMESPHERE">HOMESPHERE</option><option value="PARCERIAS">PARCERIAS</option><option value="DIRETORIA">DIRETORIA</option><option value="YUNY SELL">YUNY SELL</option></select></div>
            <div class="filter-group"><label for="filterTipo"><i class="fas fa-tag"></i> Tipo de Visita</label><select id="filterTipo" class="filter-select"><option value="todos">Todos os Tipos</option><option value="Vez">Vez</option><option value="Indicação">Indicação</option><option value="Retorno">Retorno</option><option value="Ligação">Ligação</option></select></div>
            <div class="filter-actions"><button class="btn btn-primary" onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Aplicar Filtros</button><button class="btn btn-secondary" onclick="limparFiltros()"><i class="fas fa-undo"></i> Limpar</button><button class="btn btn-success" onclick="exportarParaCSV()"><i class="fas fa-download"></i> Exportar CSV</button></div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#3b82f6"><i class="fas fa-calendar-check"></i></div><h3>Total de Atendimentos</h3></div><div class="metric-content"><strong id="totalAtendimentos">0</strong><p class="info-text">No período selecionado</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#10b981"><i class="fas fa-store-alt"></i></div><h3>YUNY STORE</h3></div><div class="metric-content"><strong id="totalStore">0</strong><p class="info-text">Atendimentos da Store</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#f59e0b"><i class="fas fa-home"></i></div><h3>HOMESPHERE</h3></div><div class="metric-content"><strong id="totalHomesphere">0</strong><p class="info-text">Atendimentos Homesphere</p></div></div>
            <div class="metric-card"><div class="metric-header"><div class="icon" style="color:#ef4444"><i class="fas fa-handshake"></i></div><h3>PARCERIAS</h3></div><div class="metric-content"><strong id="totalParcerias">0</strong><p class="info-text">Atendimentos Parcerias</p></div></div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><h4><i class="fas fa-chart-pie"></i> Atendimentos por Diretoria</h4><div class="chart-container"><canvas id="chartDiretoriaAtendimentos"></canvas></div></div>
            <div class="chart-card"><h4><i class="fas fa-chart-bar"></i> Atendimentos por Tipo</h4><div class="chart-container"><canvas id="chartTipoAtendimentos"></canvas></div></div>
        </div>

        <div class="table-container">
            <div class="table-header"><h3 class="table-title">Registro de Atendimentos</h3><div class="table-actions"><input type="text" id="searchInput" class="search-box" placeholder="Buscar..." onkeyup="filtrarTabela()"><button class="btn btn-secondary" onclick="limparBusca()"><i class="fas fa-times"></i> Limpar</button></div></div>
            <div class="table-responsive"><table class="atendimentos-table"><thead><tr><th>Data</th><th>Tipo de Visita</th><th>Corretor</th><th>Gerente</th><th>Empresa</th></tr></thead><tbody id="tabelaAtendimentos"><tr><td colspan="5" class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados da planilha...</td></tr></tbody></table></div>
            <div class="pagination"><div class="pagination-info" id="paginationInfo">Mostrando 0 de 0 registros</div><div class="pagination-controls"><button class="pagination-btn" onclick="mudarPagina(-1)" disabled id="btnPrev"><i class="fas fa-chevron-left"></i> Anterior</button><button class="pagination-btn" onclick="mudarPagina(1)" id="btnNext">Próxima <i class="fas fa-chevron-right"></i></button></div></div>
        </div>
    </div>

    <!-- ABA 6 Pipeline -->
    <div id="tratativas" class="dashboard">
        <div class="header-pipeline"><h1 class="dashboard-title"><i class="fas fa-filter" style="color:#3b82f6"></i> Pipeline de Tratativas</h1><p class="dashboard-subtitle">Visão detalhada do funil de vendas</p><div id="pipelineStatusArea" style="margin-top:10px; font-size:.9em;"></div></div>
        <div class="pipeline-container">
            <div class="pipeline-col vendido"><div class="col-header"><h3>Unidades Vendidas</h3><div class="count"><span>Total:</span><span class="count-value" id="countVendido">0</span></div><div class="vgv-total" id="vgvVendido">R$ 0</div></div><div class="col-content" id="pipelineVendido"></div></div>
            <div class="pipeline-col processo"><div class="col-header"><h3>Processo</h3><div class="count"><span>Total:</span><span class="count-value" id="countProcesso">0</span></div><div class="vgv-total" id="vgvProcesso">R$ 0</div></div><div class="col-content" id="pipelineProcesso"></div></div>
            <div class="pipeline-col proposta"><div class="col-header"><h3>Propostas</h3><div class="count"><span>Total:</span><span class="count-value" id="countProposta">0</span></div><div class="vgv-total" id="vgvProposta">R$ 0</div></div><div class="col-content" id="pipelineProposta"></div></div>
            <div class="pipeline-col tratativa"><div class="col-header"><h3>Tratativas</h3><div class="count"><span>Total:</span><span class="count-value" id="countTratativa">0</span></div><div class="vgv-total" id="vgvTratativa">R$ 0</div></div><div class="col-content" id="pipelineTratativa"></div></div>
        </div>
    </div>
</div>

<script>
/*
  JS atualizado: corrige performance cards, carrega pipeline, reativa gráficos de panorama,
  reativa gráficos e filtros de controle de atendimentos, e evita erros ao manipular elementos inexistentes.
*/

    // Globals
    let atendimentosData = [];
    let atendimentosFiltrados = [];
    let atendimentosPaginados = [];
    let paginaAtual = 1;
    const itensPorPagina = 10;

    let chartDiretoriaSemana = null;
    let chartTipoAtendimentoSemana = null;

    // panorama charts
    let chartVendasTorre = null;
    let chartOrigemVendas = null;
    let chartPerformance = null;
    let chartVendasEstoque = null;

    let chartDiretoriaAtendimentos = null;
    let chartTipoAtendimentos = null;

    // pipeline data
    let pipelineData = [];

    // URLs mantidas do seu arquivo
    const SHEET_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTx2cJTokag2KDlpWxGK5V3yk3hFehgxUrVIw9vll3ES4SduXdYTLQLtKDjWQUdCvkLa3M0teXdxeEc/pub?gid=0&single=true&output=csv';
    const PIPELINE_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSWVGFr4bPew5Q4j3mo2QLY2tPgNSDFjZ4T40X3-D8bnWwIPKnHf_nhvWE34WMRJEqGYqD3e3hnKvDz/pub?gid=0&single=true&output=csv';

    // Column names (expected)
    const COL_DATA = 'Data';
    const COL_TIPO = 'TIPO DE VISITA';
    const COL_GERENTE = 'Gerente';
    const COL_CORRETOR = 'Corretor de atendimento';
    const COL_DIRETORIA = 'Empresa';
    const COL_MIDIA = 'Mídia';

    const COL_PIPELINE_STATUS = 'STATUS';
    const COL_PIPELINE_EMPRESA = 'EMPRESA';
    const COL_PIPELINE_UNIDADE = 'UNIDADE';
    const COL_PIPELINE_ORIGEM = 'ORIGEM';
    const COL_PIPELINE_TOOLTIP = 'TOOLTIP';
    const COL_PIPELINE_VGV = 'VGV';

    // Helpers
    function parseDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            return new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00`);
        }
        if (dateStr.includes('-')) return new Date(dateStr + 'T00:00:00');
        return null;
    }

    function formatCurrency(value) {
        const v = Number(String(value).replace(/[^\d\.-]/g,''));
        if (isNaN(v)) return 'R$ 0';
        return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function normalizeText(val) {
        if (val === undefined || val === null) return 'NÃO INFORMADA';
        let s = String(val).trim();
        s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        return s.toUpperCase();
    }

    function getOrigemFromItem(item) {
        if (!item || typeof item !== 'object') return 'NÃO INFORMADA';
        const possibleKeys = [COL_MIDIA, 'MIDIA', 'MÍDIA', 'ORIGEM', 'ORIGEM/MIDIA', 'MEIO', 'MIDO', 'MÍDIA/ORIGEM'];
        for (const k of possibleKeys) {
            if (Object.prototype.hasOwnProperty.call(item, k) && item[k] !== undefined && String(item[k]).trim() !== '') {
                return normalizeText(item[k]);
            }
        }
        const keys = Object.keys(item || {});
        for (const k of keys) {
            const up = k.toUpperCase();
            if (up.includes('ORIG') || up.includes('MID')) {
                if (item[k] !== undefined && String(item[k]).trim() !== '') {
                    return normalizeText(item[k]);
                }
            }
        }
        return 'NÃO INFORMADA';
    }

    function csvToJson(csv) {
        const lines = csv.split('\n').filter(l => l.trim() !== '');
        if (lines.length <= 1) return { data: [], headersFound: {} };

        const firstLine = lines[0];
        let delimiter = firstLine.includes(';') ? ';' : (firstLine.includes('\t') ? '\t' : ',');

        const originalHeaders = firstLine.split(delimiter).map(h => h.trim().replace(/"/g, ''));
        const normalizedHeaders = originalHeaders.map(h => h.toUpperCase());
        const result = [];
        const headersFound = {};

        const expectedHeaders = [COL_DATA, COL_TIPO, COL_GERENTE, COL_CORRETOR, COL_DIRETORIA, COL_MIDIA,
            COL_PIPELINE_STATUS, COL_PIPELINE_EMPRESA, COL_PIPELINE_UNIDADE, COL_PIPELINE_ORIGEM, COL_PIPELINE_TOOLTIP, COL_PIPELINE_VGV];

        const headerIndexMap = {};
        expectedHeaders.forEach(expectedKey => {
            const keyToSearch = expectedKey.toUpperCase();
            const foundIndex = normalizedHeaders.findIndex(h => h === keyToSearch);
            if (foundIndex !== -1) {
                headerIndexMap[expectedKey] = foundIndex;
                headersFound[expectedKey] = true;
            }
        });

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line.length) continue;
            const currentline = line.split(delimiter);
            const obj = {};
            let isRowEmpty = true;
            for (const expectedKey of expectedHeaders) {
                const columnIndex = headerIndexMap[expectedKey];
                if (columnIndex !== undefined && currentline.length > columnIndex) {
                    let value = currentline[columnIndex] || '';
                    value = value.trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                    obj[expectedKey] = value;
                    if (value.length > 0) isRowEmpty = false;
                }
            }
            if (!isRowEmpty) result.push(obj);
        }
        return { data: result, headersFound };
    }

    // Load atendimentos + pipeline
    async function carregarDadosPlanilha() {
        const tabelaBody = document.getElementById('tabelaAtendimentos');
        const statusArea = document.getElementById('statusArea');

        if (tabelaBody) tabelaBody.innerHTML = `<tr><td colspan="5" class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>`;
        if (statusArea) statusArea.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados de Atendimentos...</div>`;

        try {
            const response = await fetch(SHEET_DATA_URL);
            if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
            const csvText = await response.text();
            const { data, headersFound } = csvToJson(csvText);
            atendimentosData = data;
            atendimentosFiltrados = atendimentosData.slice();

            if (!headersFound[COL_DATA]) {
                if (statusArea) statusArea.innerHTML = `<div class="error-message"><i class="fas fa-times-circle"></i> ERRO: coluna 'Data' não encontrada no CSV de Atendimentos.</div>`;
                return;
            }

            if (atendimentosData.length === 0) {
                if (statusArea) statusArea.innerHTML = `<div class="warning-message"><i class="fas fa-exclamation-triangle"></i> Planilha carregada, mas sem registros válidos.</div>`;
            } else {
                if (statusArea) statusArea.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i> Dados de Atendimentos carregados. Total: ${atendimentosData.length} registros.</div>`;
            }

            // carregar pipeline (se disponível)
            await carregarDadosPipeline();

            // inicializações
            definirSemanaAtual();
            limparFiltros(true);
            montarTabelaAtendimentos();
            inicializarGraficosPanorama();
        } catch (err) {
            console.error('Erro ao carregar atendimentos:', err);
            if (tabelaBody) tabelaBody.innerHTML = `<tr><td colspan="5" class="error-message"><i class="fas fa-exclamation-triangle"></i> Falha ao carregar dados de Atendimentos.</td></tr>`;
            const statusArea = document.getElementById('statusArea');
            if (statusArea) statusArea.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Erro: Não foi possível buscar o CSV de Atendimentos. Detalhe: ${err.message}</div>`;
        }
    }

    async function carregarDadosPipeline() {
        const pipelineStatus = document.getElementById('pipelineStatusArea');
        if (pipelineStatus) pipelineStatus.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados de Pipeline...</div>`;
        try {
            const resp = await fetch(PIPELINE_DATA_URL);
            if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
            const txt = await resp.text();
            const { data, headersFound } = csvToJson(txt);
            pipelineData = data;
            if (pipelineStatus) pipelineStatus.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i> Pipeline carregado. Registros: ${pipelineData.length}</div>`;
        } catch (e) {
            console.warn('Não foi possível carregar pipeline:', e);
            pipelineData = [];
            if (pipelineStatus) pipelineStatus.innerHTML = `<div class="warning-message"><i class="fas fa-exclamation-triangle"></i> Não foi possível carregar o CSV de Pipeline. Alguns gráficos podem ficar vazios.</div>`;
        }
    }

    // Resumo da semana helpers
    function definirSemanaAtual() {
        const hoje = new Date();
        const dia = hoje.getDay();
        // ajusta segunda (1) ... domingo manejo
        const segunda = new Date(hoje);
        segunda.setDate(hoje.getDate() - (dia === 0 ? 6 : dia - 1));
        const domingo = new Date(segunda);
        domingo.setDate(segunda.getDate() + 6);
        document.getElementById('resumoDataInicio').value = segunda.toISOString().split('T')[0];
        document.getElementById('resumoDataFim').value = domingo.toISOString().split('T')[0];
        aplicarFiltroResumo();
    }

    function aplicarFiltroResumo() {
        const dataInicioStr = document.getElementById('resumoDataInicio').value;
        const dataFimStr = document.getElementById('resumoDataFim').value;
        if (!dataInicioStr || !dataFimStr) { mostrarNotificacao('Selecione ambas as datas','warning'); return; }
        const dataInicio = new Date(dataInicioStr + 'T00:00:00');
        const dataFim = new Date(dataFimStr + 'T23:59:59');

        dadosResumoFiltrados = atendimentosData.filter(item => {
            const itemDate = parseDate(item[COL_DATA]);
            if (!itemDate) return false;
            return itemDate >= dataInicio && itemDate <= dataFim;
        });

        atualizarResumoPeriodo(dataInicio, dataFim);
        calcularMetricasResumo();
        inicializarGraficosResumo();
        atualizarTimelineOrigem();
        atualizarCardsPerformanceSemanal();
    }

    function atualizarResumoPeriodo(inicio, fim) {
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const inicioStr = inicio.toLocaleDateString('pt-BR', options);
        const fimStr = fim.toLocaleDateString('pt-BR', options);
        const el = document.getElementById('resumoPeriodo');
        if (el) el.textContent = `Período: ${inicioStr} a ${fimStr}`;
    }

    // Métricas resumo (corrigida)
    let dadosResumoFiltrados = [];

    function calcularMetricasResumo() {
        const tipos = ['VEZ','INDI','RETORNO','PROPOSTA'];
        const diretorias = {};

        // inicializa contadores
        dadosResumoFiltrados.forEach(item => {
            const dirRaw = (item[COL_DIRETORIA] || 'NÃO INFORMADA').trim();
            const dir = normalizeText(dirRaw);
            if (!diretorias[dir]) {
                diretorias[dir] = { label: dirRaw, visitas:0, indicacoes:0, retornos:0, propostas:0 };
            }
            const tipo = (item[COL_TIPO] || '').toUpperCase();
            if (tipo.includes('VEZ')) diretorias[dir].visitas++;
            else if (tipo.includes('INDI')) diretorias[dir].indicacoes++;
            else if (tipo.includes('RETORNO')) diretorias[dir].retornos++;
            else if (tipo.includes('PROPOSTA')) diretorias[dir].propostas++;
        });

        // totais gerais
        const totals = { visitas:0, indicacoes:0, retornos:0, propostas:0 };
        for (const d of Object.values(diretorias)) {
            totals.visitas += d.visitas;
            totals.indicacoes += d.indicacoes;
            totals.retornoes = totals.retornoes; // placeholder
            totals.retornoes = totals.retornoes; // nothing
            totals.retornoes = totals.retornoes; // keep consistent (no-op)
            totals.retornoes = totals.retornoes;
            totals.retornoes = totals.retornoes;
        }
        // simpler compute totals directly from dadosResumoFiltrados
        totals.visitas = dadosResumoFiltrados.filter(i=> (i[COL_TIPO]||'').toUpperCase().includes('VEZ')).length;
        totals.indicacoes = dadosResumoFiltrados.filter(i=> (i[COL_TIPO]||'').toUpperCase().includes('INDI')).length;
        totals.retornoes = dadosResumoFiltrados.filter(i=> (i[COL_TIPO]||'').toUpperCase().includes('RETORNO')).length;
        totals.propostas = dadosResumoFiltrados.filter(i=> (i[COL_TIPO]||'').toUpperCase().includes('PROPOSTA')).length;

        // Atualiza cards principais
        const elVis = document.getElementById('resumoVisitas'); if (elVis) elVis.textContent = totals.visitas;
        const elInd = document.getElementById('resumoIndicacoes'); if (elInd) elInd.textContent = totals.indicacoes;
        const elRet = document.getElementById('resumoRetornos'); if (elRet) elRet.textContent = totals.retornoes;
        const elProp = document.getElementById('resumoPropostas'); if (elProp) elProp.textContent = totals.propostas;

        // detalhes por diretoria (formato "Store: X / Homesphere: Y ...")
        function formatDetalhe(field) {
            const parts = [];
            for (const [k,v] of Object.entries(diretorias)) {
                const label = diretorias[k].label;
                const val = diretorias[k][field] || 0;
                if (val > 0) parts.push(`${label}: ${val}`);
            }
            return parts.join(' / ') || 'Nenhuma diretoria';
        }

        const elVisDet = document.getElementById('resumoVisitasDetalhe'); if (elVisDet) elVisDet.textContent = formatDetalhe('visitas');
        const elIndDet = document.getElementById('resumoIndicacoesDetalhe'); if (elIndDet) elIndDet.textContent = formatDetalhe('indicacoes');
        const elRetDet = document.getElementById('resumoRetornosDetalhe'); if (elRetDet) elRetDet.textContent = formatDetalhe('retornos');
        const elPropDet = document.getElementById('resumoPropostasDetalhe'); if (elPropDet) elPropDet.textContent = formatDetalhe('propostas');
    }

    // Gráficos do resumo
    function inicializarGraficosResumo() {
        // diretoria
        const contagem = {};
        dadosResumoFiltrados.forEach(item => {
            const d = (item[COL_DIRETORIA] || 'NÃO INFORMADA').trim().toUpperCase();
            contagem[d] = (contagem[d] || 0) + 1;
        });
        const labels = Object.keys(contagem);
        const values = labels.map(l => contagem[l]);
        const ctx = document.getElementById('chartDiretoriaSemana');
        if (ctx) {
            if (chartDiretoriaSemana) chartDiretoriaSemana.destroy();
            chartDiretoriaSemana = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data: values }] }, options:{ plugins:{ legend:{ position:'bottom' } } } });
        }

        // tipo atendimento
        const tipoCount = {};
        dadosResumoFiltrados.forEach(item => {
            const t = (item[COL_TIPO] || 'NÃO INFORMADO').trim().toUpperCase();
            tipoCount[t] = (tipoCount[t] || 0) + 1;
        });
        const labels2 = Object.keys(tipoCount);
        const values2 = labels2.map(l => tipoCount[l]);
        const ctx2 = document.getElementById('chartTipoAtendimento');
        if (ctx2) {
            if (chartTipoAtendimentoSemana) chartTipoAtendimentoSemana.destroy();
            chartTipoAtendimentoSemana = new Chart(ctx2, { type:'bar', data:{ labels: labels2, datasets:[{ data: values2 }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
        }
    }

    // Timeline origem
    function atualizarTimelineOrigem() {
        const timelineContainer = document.getElementById('timelineOrigem');
        if (!timelineContainer) return;
        timelineContainer.innerHTML = '';

        const visitasPorMidia = {};
        const indicacoesPorMidia = {};
        const retornosPorMidia = {};

        dadosResumoFiltrados.forEach(item => {
            const tipo = normalizeText(item[COL_TIPO] || '');
            const midia = getOrigemFromItem(item);
            if (tipo.includes('VEZ')) visitasPorMidia[midia] = (visitasPorMidia[midia]||0) + 1;
            else if (tipo.includes('INDI')) indicacoesPorMidia[midia] = (indicacoesPorMidia[midia]||0) + 1;
            else if (tipo.includes('RETORNO')) retornosPorMidia[midia] = (retornosPorMidia[midia]||0) + 1;
        });

        function criarCard(title, subtitle, mapObj) {
            if (!mapObj || Object.keys(mapObj).length === 0) return null;
            const total = Object.values(mapObj).reduce((a,b)=>a+b,0);
            const card = document.createElement('div');
            card.className = 'timeline-card';
            card.innerHTML = `<h4>${title}</h4><h5>${subtitle}</h5><p style="margin-bottom:10px;">Total: ${total} atendimentos</p><ul>${Object.entries(mapObj).sort((a,b)=>b[1]-a[1]).map(([m,c])=>`<li>${m} → ${c}</li>`).join('')}</ul>`;
            return card;
        }

        const visitasCard = criarCard('<i class="fas fa-map-marked-alt"></i> Visitas','Origem das Visitas',visitasPorMidia);
        const indicacoesCard = criarCard('<i class="fas fa-user-check"></i> Indicações','Origem das Indicações',indicacoesPorMidia);
        const retornosCard = criarCard('<i class="fas fa-reply"></i> Retornos','Origem dos Retornos',retornosPorMidia);

        if (visitasCard) timelineContainer.appendChild(visitasCard);
        if (indicacoesCard) timelineContainer.appendChild(indicacoesCard);
        if (retornosCard) timelineContainer.appendChild(retornosCard);
        if (timelineContainer.children.length === 0) timelineContainer.innerHTML = '<div class="loading">Nenhum dado de origem encontrado para o período selecionado.</div>';
    }

    // Atualizar cards de performance (AGORA com detalhes por tipo como pediu)
    function atualizarCardsPerformanceSemanal() {
        const container = document.getElementById('cardsPerformanceSemanal');
        if (!container) return;
        container.innerHTML = '';

        const dadosPorDiretoria = {};

        dadosResumoFiltrados.forEach(item => {
            const raw = (item[COL_DIRETORIA] || 'NÃO INFORMADA').trim();
            const key = normalizeText(raw);
            if (!dadosPorDiretoria[key]) dadosPorDiretoria[key] = { label: raw, visitas:0, indicacoes:0, retornos:0, propostas:0 };
            const tipo = (item[COL_TIPO] || '').toUpperCase();
            if (tipo.includes('VEZ')) dadosPorDiretoria[key].visitas++;
            else if (tipo.includes('INDI')) dadosPorDiretoria[key].indicacoes++;
            else if (tipo.includes('RETORNO')) dadosPorDiretoria[key].retornos++;
            else if (tipo.includes('PROPOSTA')) dadosPorDiretoria[key].propostas++;
        });

        function getClassForDiretoria(nameUpper) {
            if (!nameUpper) return '';
            if (nameUpper.includes('STORE')) return 'store';
            if (nameUpper.includes('SELL') || nameUpper.includes('YUNYSELL') || nameUpper.includes('YUNY SELL')) return 'sell';
            if (nameUpper.includes('HOMESPHERE')) return 'homesphere';
            if (nameUpper.includes('PARCERIA')) return 'parcerias';
            if (nameUpper.includes('FERRARI')) return 'ferrari';
            if (nameUpper.includes('DIRETORIA')) return 'diretoria';
            return '';
        }

        for (const [k,dados] of Object.entries(dadosPorDiretoria)) {
            const total = dados.visitas + dados.indicacoes + dados.retornos + dados.propostas;
            const classe = getClassForDiretoria(k);
            const card = document.createElement('div');
            card.className = `card-performance ${classe}`;
            card.innerHTML = `<h3>${dados.label}</h3>
                <p style="font-weight:600; color:var(--gray); margin-top:6px;">Performance do Mês</p>
                <p>Visitas: <strong>${dados.visitas}</strong></p>
                <p>Indicações: <strong>${dados.indicacoes}</strong></p>
                <p>Retornos: <strong>${dados.retornos}</strong></p>
                <p>Propostas: <strong>${dados.propostas}</strong></p>
                <p style="margin-top:8px;">Total: <strong>${total}</strong></p>`;
            container.appendChild(card);
        }

        if (Object.keys(dadosPorDiretoria).length === 0) {
            container.innerHTML = '<div class="loading">Nenhum dado encontrado no período selecionado.</div>';
        }
    }

    // CONTROLE DE ATENDIMENTOS: filtros, tabela, paginação e gráficos
    function aplicarFiltros() {
        const inicio = document.getElementById('filterDataInicio').value;
        const fim = document.getElementById('filterDataFim').value;
        const diretoria = document.getElementById('filterDiretoria').value;
        const tipo = document.getElementById('filterTipo').value;

        atendimentosFiltrados = atendimentosData.filter(item => {
            const itemDate = parseDate(item[COL_DATA]);
            if (!itemDate) return false;
            if (inicio) { const start = new Date(inicio + 'T00:00:00'); if (itemDate < start) return false; }
            if (fim) { const end = new Date(fim + 'T23:59:59'); if (itemDate > end) return false; }
            if (diretoria && diretoria !== 'todas') { const emp = (item[COL_DIRETORIA] || '').toUpperCase(); if (!emp.includes(diretoria)) return false; }
            if (tipo && tipo !== 'todos') { const t = (item[COL_TIPO] || '').toUpperCase(); if (!t.includes(tipo.toUpperCase())) return false; }
            return true;
        });

        paginaAtual = 1;
        montarTabelaAtendimentos();
    }

    function limparFiltros(skipInit) {
        document.getElementById('filterDataInicio').value = '';
        document.getElementById('filterDataFim').value = '';
        document.getElementById('filterDiretoria').value = 'todas';
        document.getElementById('filterTipo').value = 'todos';
        if (!skipInit) {
            atendimentosFiltrados = atendimentosData.slice();
            paginaAtual = 1;
            montarTabelaAtendimentos();
        } else {
            atendimentosFiltrados = atendimentosData.slice();
        }
    }

    function montarTabelaAtendimentos() {
        const tbody = document.getElementById('tabelaAtendimentos');
        if (!tbody) return;
        tbody.innerHTML = '';
        const start = (paginaAtual - 1) * itensPorPagina;
        const pageItems = atendimentosFiltrados.slice(start, start + itensPorPagina);

        if (pageItems.length === 0) tbody.innerHTML = `<tr><td colspan="5">Nenhum registro encontrado.</td></tr>`;
        else {
            pageItems.forEach(row => {
                const tr = document.createElement('tr');
                const tdData = document.createElement('td'); tdData.textContent = row[COL_DATA] || ''; tr.appendChild(tdData);
                const tdTipo = document.createElement('td'); tdTipo.textContent = row[COL_TIPO] || ''; tr.appendChild(tdTipo);
                const tdCorretor = document.createElement('td'); tdCorretor.textContent = row[COL_CORRETOR] || ''; tr.appendChild(tdCorretor);
                const tdGerente = document.createElement('td'); tdGerente.textContent = row[COL_GERENTE] || ''; tr.appendChild(tdGerente);
                const tdEmpresa = document.createElement('td');
                const emp = row[COL_DIRETORIA] || '';
                const span = document.createElement('span'); span.className = 'diretoria-badge';
                const up = (emp || '').toUpperCase();
                if (up.includes('STORE')) span.classList.add('diretoria-store');
                else if (up.includes('HOMESPHERE')) span.classList.add('diretoria-homesphere');
                else if (up.includes('PARCERIAS')) span.classList.add('diretoria-parcerias');
                else if (up.includes('FERRARI')) span.classList.add('diretoria-ferrari');
                else if (up.includes('DIRETORIA')) span.classList.add('diretoria-diretoria');
                else if (up.includes('SELL') || up.includes('YUNYSELL')) span.classList.add('diretoria-sell');
                span.textContent = emp || 'NÃO INFORMADA';
                tdEmpresa.appendChild(span);
                tr.appendChild(tdEmpresa);
                tbody.appendChild(tr);
            });
        }

        const paginationInfo = document.getElementById('paginationInfo');
        if (paginationInfo) paginationInfo.textContent = `Mostrando ${Math.min(atendimentosFiltrados.length, start+1)} até ${Math.min(atendimentosFiltrados.length, start+pageItems.length)} de ${atendimentosFiltrados.length} registros`;
        document.getElementById('btnPrev').disabled = paginaAtual === 1;
        document.getElementById('btnNext').disabled = (paginaAtual * itensPorPagina) >= atendimentosFiltrados.length;

        // atualizar indicadores da aba controle
        document.getElementById('totalAtendimentos').textContent = atendimentosFiltrados.length;
        document.getElementById('totalStore').textContent = atendimentosFiltrados.filter(i => (i[COL_DIRETORIA]||'').toUpperCase().includes('STORE')).length;
        document.getElementById('totalHomesphere').textContent = atendimentosFiltrados.filter(i => (i[COL_DIRETORIA]||'').toUpperCase().includes('HOMESPHERE')).length;
        document.getElementById('totalParcerias').textContent = atendimentosFiltrados.filter(i => (i[COL_DIRETORIA]||'').toUpperCase().includes('PARCERIAS')).length;

        atualizarGraficosControleAtendimentos();
    }

    function mudarPagina(dir) { paginaAtual += dir; montarTabelaAtendimentos(); }

    function filtrarTabela() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        atendimentosFiltrados = atendimentosData.filter(row => Object.values(row).some(v => (v||'').toString().toLowerCase().includes(q)));
        paginaAtual = 1;
        montarTabelaAtendimentos();
    }

    function limparBusca() { document.getElementById('searchInput').value = ''; atendimentosFiltrados = atendimentosData.slice(); montarTabelaAtendimentos(); }

    function exportarParaCSV() {
        if (!atendimentosFiltrados.length) { mostrarNotificacao('Nenhum dado para exportar','warning'); return; }
        const rows = [Object.keys(atendimentosData[0] || {}).join(',')];
        atendimentosFiltrados.forEach(r => {
            const vals = Object.keys(r).map(k => `"${(r[k]||'').replace(/"/g,'""')}"`);
            rows.push(vals.join(','));
        });
        const csv = rows.join('\n'); const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'atendimentos_export.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // Graficos da aba controle
    function atualizarGraficosControleAtendimentos() {
        // diretoria
        const cont = {};
        atendimentosFiltrados.forEach(i => { const d = (i[COL_DIRETORIA]||'NÃO INFORMADA').toUpperCase(); cont[d] = (cont[d]||0)+1; });
        const labels = Object.keys(cont); const values = labels.map(l=>cont[l]);
        const ctx = document.getElementById('chartDiretoriaAtendimentos');
        if (ctx) {
            if (chartDiretoriaAtendimentos) chartDiretoriaAtendimentos.destroy();
            chartDiretoriaAtendimentos = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data:values }] }, options:{ plugins:{ legend:{ position:'bottom' } } } });
        }

        // tipo
        const tcont = {};
        atendimentosFiltrados.forEach(i => { const t = (i[COL_TIPO]||'NÃO INFORMADO').toUpperCase(); tcont[t] = (tcont[t]||0)+1; });
        const labels2 = Object.keys(tcont); const values2 = labels2.map(l=>tcont[l]);
        const ctx2 = document.getElementById('chartTipoAtendimentos');
        if (ctx2) {
            if (chartTipoAtendimentos) chartTipoAtendimentos.destroy();
            chartTipoAtendimentos = new Chart(ctx2, { type:'bar', data:{ labels: labels2, datasets:[{ data: values2 }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
        }
    }

    // PANORAMA: inicializadores simples baseados em pipelineData (se carregado)
    function inicializarGraficosPanorama() {
        // atualizar métricas de topo
        document.getElementById('pan_unidades_real').textContent = pipelineData.length ? pipelineData.length : '--';
        // total VGV:
        const totalVGV = pipelineData.reduce((s,row) => { const v = Number(String(row[COL_PIPELINE_VGV]||'').replace(/[^\d\.-]/g,'')); return s + (isNaN(v) ? 0 : v); }, 0);
        document.getElementById('pan_vgv_real').textContent = totalVGV ? formatCurrency(totalVGV) : '--';
        document.getElementById('pan_out_unidades').textContent = '--';
        document.getElementById('pan_estoque').textContent = '--';
        document.getElementById('pan_unidades_info').textContent = pipelineData.length ? 'Dados carregados do Pipeline' : 'Nenhum dado de pipeline';

        // Vendas por Torre (UNIDADE)
        const byTorre = {};
        pipelineData.forEach(r => { const u = (r[COL_PIPELINE_UNIDADE]||'NÃO INFORMADA').toUpperCase(); byTorre[u] = (byTorre[u]||0)+1; });
        const labels = Object.keys(byTorre); const values = labels.map(l=>byTorre[l]);
        const ctx = document.getElementById('chartVendasTorre');
        if (ctx) { if (chartVendasTorre) chartVendasTorre.destroy(); chartVendasTorre = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data:values }] }, options:{ plugins:{ legend:{ position:'bottom' } } } }); }

        // Origem das vendas
        const byOrig = {};
        pipelineData.forEach(r => { const o = normalizeText(r[COL_PIPELINE_ORIGEM]||'NÃO INFORMADA'); byOrig[o] = (byOrig[o]||0)+1; });
        const labels2 = Object.keys(byOrig); const values2 = labels2.map(l=>byOrig[l]);
        const ctx2 = document.getElementById('chartOrigemVendas');
        if (ctx2) { if (chartOrigemVendas) chartOrigemVendas.destroy(); chartOrigemVendas = new Chart(ctx2, { type:'bar', data:{ labels: labels2, datasets:[{ data: values2 }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } }); }

        // Performance (VGV por empresa)
        const vgvByEmp = {};
        pipelineData.forEach(r => { const e = (r[COL_PIPELINE_EMPRESA]||'NÃO INFORMADA').toUpperCase(); const v = Number(String(r[COL_PIPELINE_VGV]||'').replace(/[^\d\.-]/g,'')); vgvByEmp[e] = (vgvByEmp[e]||0) + (isNaN(v)?0:v); });
        const labels3 = Object.keys(vgvByEmp); const values3 = labels3.map(l=>vgvByEmp[l]);
        const ctx3 = document.getElementById('chartPerformance');
        if (ctx3) { if (chartPerformance) chartPerformance.destroy(); chartPerformance = new Chart(ctx3, { type:'bar', data:{ labels: labels3, datasets:[{ data: values3 }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ callback: function(val){ return formatCurrency(val); } } } } } }); }

        // Vendas vs Estoque (simples: vendidos = pipeline STATUS='VENDIDO', estoque = total - vendidos)
        const vendidos = pipelineData.filter(r => (r[COL_PIPELINE_STATUS]||'').toUpperCase().includes('VEND')).length;
        const total = pipelineData.length;
        const estoque = Math.max(0, total - vendidos);
        const ctx4 = document.getElementById('chartVendasEstoque');
        if (ctx4) {
            if (chartVendasEstoque) chartVendasEstoque.destroy();
            chartVendasEstoque = new Chart(ctx4, { type:'doughnut', data:{ labels:['Vendidas','Estoque'], datasets:[{ data:[vendidos,estoque] }] }, options:{ plugins:{ legend:{ position:'bottom' } } } });
        }
    }

    // Pipeline: monta colunas simples
    function popularPipelineNaTela() {
        if (!pipelineData || !pipelineData.length) {
            document.getElementById('pipelineVendido').innerHTML = '<div class="loading">Nenhum dado de pipeline carregado.</div>';
            return;
        }
        // limpa
        ['pipelineVendido','pipelineProcesso','pipelineProposta','pipelineTratativa'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; });
        const statusMap = { 'VENDIDO':'pipelineVendido','PROCESSO':'pipelineProcesso','PROPOSTA':'pipelineProposta','TRATATIVA':'pipelineTratativa' };
        const counts = { vendido:0, processo:0, proposta:0, tratativa:0 };

        pipelineData.forEach(row => {
            const status = (row[COL_PIPELINE_STATUS]||'').toUpperCase();
            const targetId = statusMap[status] || 'pipelineTratativa';
            const container = document.getElementById(targetId);
            const div = document.createElement('div');
            div.className = 'tratativa-row';
            div.innerHTML = `<div class="row-unit">${row[COL_PIPELINE_UNIDADE]||'Unidade'}</div><div class="row-origin">${row[COL_PIPELINE_EMPRESA]||''}</div>`;
            if (container) container.appendChild(div);

            if (status.includes('VEND')) counts.vendido++;
            else if (status.includes('PROCESS')) counts.processo++;
            else if (status.includes('PROPOSTA')) counts.proposta++;
            else counts.tratativa++;
        });

        document.getElementById('countVendido').textContent = counts.vendido;
        document.getElementById('countProcesso').textContent = counts.processo;
        document.getElementById('countProposta').textContent = counts.proposta;
        document.getElementById('countTratativa').textContent = counts.tratativa;

        const vgvSum = pipelineData.reduce((s,row)=> s + (Number(String(row[COL_PIPELINE_VGV]||'').replace(/[^\d\.-]/g,''))||0),0);
        document.getElementById('vgvVendido').textContent = formatCurrency(vgvSum);
    }

    // Notificacoes simples
    function mostrarNotificacao(msg, type) {
        const statusArea = document.getElementById('statusArea');
        if (!statusArea) return;
        statusArea.innerHTML = `<div class="${type==='error'?'error-message':type==='warning'?'warning-message':'success-message'}">${msg}</div>`;
        setTimeout(()=> { if (statusArea) statusArea.innerHTML=''; }, 4000);
    }

    // Inits
    document.addEventListener('DOMContentLoaded', () => {
        // tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.addEventListener('click', () => {
                // ignore clicks on hidden tabs
                if (getComputedStyle(t).display === 'none') return;
                document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
                t.classList.add('active');
                document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
                const target = t.getAttribute('data-target');
                if (document.getElementById(target)) document.getElementById(target).classList.add('active');

                // on tab change, (re)inicializa gráficos específicos
                if (target === 'panorama-estoque') inicializarGraficosPanorama();
                if (target === 'controle-atendimentos') montarTabelaAtendimentos();
                if (target === 'tratativas') popularPipelineNaTela();
            });
        });

        carregarDadosPlanilha().then(()=> {
            // after loading pipeline, render panorama and pipeline visuals
            inicializarGraficosPanorama();
            popularPipelineNaTela();
        });
    });
</script>
</body>
</html>
